name: Amp Review (Tier 1 - Fast Triage)

on:
  workflow_run:
    workflows: [Route PR to Model]
    types: [completed]

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  get-tier:
    runs-on: ubuntu-latest
    outputs:
      tier: ${{ steps.extract.outputs.tier }}
      reason: ${{ steps.extract.outputs.reason }}
      pr_number: ${{ steps.extract.outputs.pr_number }}
    steps:
      - name: Download routing artifacts
        uses: actions/download-artifact@v4
        with:
          name: routing-analysis
          github-token: ${{ github.token }}

      - name: Extract tier and PR number
        id: extract
        run: |
          if [ -f routing-analysis.json ]; then
            TIER=$(jq -r '.tier' routing-analysis.json)
            REASON=$(jq -r '.reason' routing-analysis.json)
            echo "tier=${TIER}" >> $GITHUB_OUTPUT
            echo "reason=${REASON}" >> $GITHUB_OUTPUT
          else
            echo "tier=2" >> $GITHUB_OUTPUT
            echo "reason=Default to Tier 2" >> $GITHUB_OUTPUT
          fi
          
          # Extract PR number from workflow_run context
          PR_NUMBER=$(jq -r '.workflow_run.pull_requests[0].number' "$GITHUB_EVENT_PATH")
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT

  amp-review:
    name: Amp Code Review (Tier 1)
    needs: get-tier
    # Only run for Tier 1 (fast triage)
    if: |
      needs.get-tier.outputs.tier == '1' &&
      (github.event.pull_request.author_association == 'OWNER' ||
       github.event.pull_request.author_association == 'MEMBER' ||
       github.event.pull_request.author_association == 'COLLABORATOR')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Run Amp Code Review (Tier 1: Fast Triage)
        uses: ampcode/action@v1
        with:
          mode: rush
          instructions: |
            ## TIER 1 CODE REVIEW (Fast Triage)
            
            This is a lightweight review for documentation-only or minimal changes.
            
            **Review Scope:**
            - Documentation clarity and completeness
            - Link validity (no broken references)
            - Formatting consistency
            - Spelling and grammar
            
            **Output Format:**
            If issues found:
            ```
            ## ðŸ“‹ Findings
            - **[doc-clarity]** Line X: Brief description of issue
            - **[broken-link]** Line Y: URL or reference that's broken
            - **[formatting]** Line Z: Formatting inconsistency
            ```
            
            If no issues:
            ```
            âœ… No issues found. Documentation is clear and well-formatted.
            ```
            
            Keep response under 10 lines. Be concise.

      - name: Post review comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const tier = '${{ needs.get-tier.outputs.tier }}';
            const reason = '${{ needs.get-tier.outputs.reason }}';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `### ðŸš€ Amp Review Complete (Tier 1 - Fast Triage)\n\n**Tier:** ${tier}\n**Reason:** ${reason}\n\nThis PR qualifies for fast-track review due to minimal scope. Review focused on documentation clarity and basic validation.`
            });

  tier1-skip:
    name: Tier 1 Eligibility Check
    needs: get-tier
    # Post a comment if PR doesn't qualify for Tier 1
    if: |
      needs.get-tier.outputs.tier != '1' &&
      (github.event.pull_request.author_association == 'OWNER' ||
       github.event.pull_request.author_association == 'MEMBER' ||
       github.event.pull_request.author_association == 'COLLABORATOR')
    runs-on: ubuntu-latest
    steps:
      - name: Post routing notice
        uses: actions/github-script@v7
        with:
          script: |
            const tier = '${{ needs.get-tier.outputs.tier }}';
            const reason = '${{ needs.get-tier.outputs.reason }}';
            
            let reviewType = '';
            if (tier === '2') {
              reviewType = '**Tier 2** - Standard complexity (Claude with GLM 4.7)';
            } else if (tier === '3') {
              reviewType = '**Tier 3** - Deep analysis required (Factory Droid with GPT-5.2)';
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `### ðŸ“Š PR Routing Decision\n\n${reviewType}\n\n**Reason:** ${reason}\n\nThis PR will be reviewed by the appropriate model based on complexity and scope.`
            });
