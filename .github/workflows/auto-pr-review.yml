name: Automatic PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  auto-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Only run for authorized users (OWNER, MEMBER, or COLLABORATOR)
    if: |
      github.event.pull_request.author_association == 'OWNER' ||
      github.event.pull_request.author_association == 'MEMBER' ||
      github.event.pull_request.author_association == 'COLLABORATOR'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for critical path changes
        id: filter
        continue-on-error: true
        uses: dorny/paths-filter@v3
        with:
          filters: |
            critical:
              - '.github/workflows/**'
              - 'next.config.js'
              - 'package.json'
              - 'pages/api/**'
              - 'pages/admin/**'
              - 'scripts/**'
              - 'src/services/**'
              - 'src/lib/**'
              - 'src/contexts/**'

      - name: Setup Node.js
        if: steps.filter.outputs.critical == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        if: steps.filter.outputs.critical == 'true'
        run: npm ci

      - name: Check CI workflow status
        id: ci-status
        if: steps.filter.outputs.critical == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Query latest CI workflow run for this PR branch
            // Note: workflow_id hardcoded to 'ci.yml' - update if CI workflow is renamed
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci.yml',
              branch: context.payload.pull_request.head.ref,
              per_page: 1
            });

            // Handle case where CI hasn't run yet (e.g., first-time contributor)
            const latestRun = runs.data.workflow_runs[0];
            const status = latestRun
              ? (latestRun.status === 'completed' ? latestRun.conclusion : 'pending')
              : 'not_run';

            core.setOutput('status', status);
            core.setOutput('url', latestRun?.html_url || '');

      - name: Run Code Review
        if: steps.filter.outputs.critical == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          claude_args: |
            --allowedTools "Read,Write,Edit,Glob,Grep,Bash(npm:*),Bash(npx:*),Bash(git:*),Bash(node:*)"
            --max-turns 10
          settings: |
            {
              "instructions": "You are a code reviewer for a PR that changes critical paths.\n\nCI Status: \"${{ steps.ci-status.outputs.status }}\"\nCI Workflow: ${{ steps.ci-status.outputs.url }}\n\nCI Status Handling:\n- 'failure': CRITICAL ISSUE - tests failing, must fix before approval\n- 'not_run': WARNING - CI hasn't run yet, recommend running tests first\n- 'pending': CI still running, review code but tests may fail\n- 'success': All tests passed, proceed with review\n\nAnalyze this PR for:\n\n1. **CI Test Results** (check above - handle based on status)\n2. **Security Issues** (OWASP Top 10, auth flaws, injection vulnerabilities)\n3. **Code Quality** (type safety, error handling, performance)\n4. **Best Practices** (framework patterns, project conventions)\n5. **Breaking Changes** (API changes, migration requirements)\n\nFormat your response as:\n\n## üö® Critical Issues (must fix)\n## ‚ö†Ô∏è Medium/Low Issues (should fix)\n## ‚úÖ Positive Findings\n## üìã Recommendation\n\nFinal line must be one of:\n- `APPROVED`\n- `NEEDS_CHANGES`\n- `REVIEW_REQUIRED`",
              "env": {
                "NODE_ENV": "test",
                "CI": "true"
              }
            }
        env:
          # Using api.z.ai proxy for cost optimization and rate limiting
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic

      - name: Post Skip Notice
        if: steps.filter.outputs.critical != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `### ‚ÑπÔ∏è Automated Review Skipped\n\nThis PR does not modify any critical paths that require automated review.\n\n**Monitored paths:**\n- \`.github/workflows/\` - CI/CD\n- \`pages/api/\` - API routes\n- \`pages/admin/\` - Admin functionality\n- \`scripts/\` - Data processing\n- \`src/services/\` - External integrations\n- \`src/lib/\` - Core utilities\n- \`src/contexts/\` - Auth/state management\n- \`next.config.js\`, \`package.json\` - Config\n\nIf you need a code review, mention \`@claude\` in a comment.`
            });
