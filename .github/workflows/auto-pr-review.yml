name: Automatic PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    # Only run for authorized users (OWNER, MEMBER, or COLLABORATOR)
    # AND only if changes affect critical paths
    if: |
      (github.event.pull_request.user.author_association == 'OWNER' ||
       github.event.pull_request.user.author_association == 'MEMBER' ||
       github.event.pull_request.user.author_association == 'COLLABORATOR') &&
      (contains(github.event.pull_request.changed_files*' ', '.github/workflows/') ||
       contains(github.event.pull_request.changed_files*' ', 'next.config.js') ||
       contains(github.event.pull_request.changed_files*' ', 'package.json') ||
       contains(github.event.pull_request.changed_files*' ', 'pages/api/') ||
       contains(github.event.pull_request.changed_files*' ', 'pages/admin/') ||
       contains(github.event.pull_request.changed_files*' ', 'scripts/') ||
       contains(github.event.pull_request.changed_files*' ', 'src/services/') ||
       contains(github.event.pull_request.changed_files*' ', 'src/lib/') ||
       contains(github.event.pull_request.changed_files*' ', 'src/contexts/'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          claude_args: |
            --allowedTools "Read,Write,Edit,Glob,Grep,Bash(npm:*),Bash(npx:*),Bash(git:*),Bash(node:*)"
            --max-turns 10
          settings: |
            {
              "instructions": "You are a code reviewer. Analyze this PR for:\n\n1. **Security Issues** (OWASP Top 10, auth flaws, injection vulnerabilities)\n2. **Code Quality** (type safety, error handling, performance)\n3. **Best Practices** (framework patterns, project conventions)\n4. **Breaking Changes** (API changes, migration requirements)\n\nFormat your response as:\n\n## ðŸš¨ Critical Issues (must fix)\n## âš ï¸ Medium/Low Issues (should fix)\n## âœ… Positive Findings\n## ðŸ“‹ Recommendation\n\nFinal line must be one of:\n- `APPROVED`\n- `NEEDS_CHANGES`\n- `REVIEW_REQUIRED`",
              "env": {
                "NODE_ENV": "test",
                "CI": "true"
              }
            }
        env:
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic

      - name: Post Review Comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const botReview = reviews.find(r => r.user.type === 'Bot' && r.user.login === 'github-actions[bot]');

            if (botReview) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `### ðŸ¤– Automated Review Complete\n\n${botReview.body}\n\n---\n\nðŸ¤– Generated by [Claude Code](https://claude.ai/code) - GLM 4.7\n\n*This review was triggered because you are an authorized contributor (OWNER/MEMBER/COLLABORATOR).*`
              });
            }
