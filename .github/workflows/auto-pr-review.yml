name: Automatic PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    # Only run for authorized users (OWNER, MEMBER, or COLLABORATOR)
    if: |
      github.event.pull_request.user.author_association == 'OWNER' ||
      github.event.pull_request.user.author_association == 'MEMBER' ||
      github.event.pull_request.user.author_association == 'COLLABORATOR'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for critical path changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            critical:
              - '.github/workflows/**'
              - 'next.config.js'
              - 'package.json'
              - 'pages/api/**'
              - 'pages/admin/**'
              - 'scripts/**'
              - 'src/services/**'
              - 'src/lib/**'
              - 'src/contexts/**'

      - name: Setup Node.js
        if: steps.filter.outputs.critical == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        if: steps.filter.outputs.critical == 'true'
        run: npm ci

      - name: Run Code Review
        if: steps.filter.outputs.critical == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          claude_args: |
            --allowedTools "Read,Write,Edit,Glob,Grep,Bash(npm:*),Bash(npx:*),Bash(git:*),Bash(node:*)"
            --max-turns 10
          settings: |
            {
              "instructions": "You are a code reviewer. Analyze this PR for:\n\n1. **Security Issues** (OWASP Top 10, auth flaws, injection vulnerabilities)\n2. **Code Quality** (type safety, error handling, performance)\n3. **Best Practices** (framework patterns, project conventions)\n4. **Breaking Changes** (API changes, migration requirements)\n\nFormat your response as:\n\n## üö® Critical Issues (must fix)\n## ‚ö†Ô∏è Medium/Low Issues (should fix)\n## ‚úÖ Positive Findings\n## üìã Recommendation\n\nFinal line must be one of:\n- `APPROVED`\n- `NEEDS_CHANGES`\n- `REVIEW_REQUIRED`",
              "env": {
                "NODE_ENV": "test",
                "CI": "true"
              }
            }
        env:
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic

      - name: Post Skip Notice
        if: steps.filter.outputs.critical != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `### ‚ÑπÔ∏è Automated Review Skipped\n\nThis PR does not modify any critical paths that require automated review.\n\n**Monitored paths:**\n- \`.github/workflows/\` - CI/CD\n- \`pages/api/\` - API routes\n- \`pages/admin/\` - Admin functionality\n- \`scripts/\` - Data processing\n- \`src/services/\` - External integrations\n- \`src/lib/\` - Core utilities\n- \`src/contexts/\` - Auth/state management\n- \`next.config.js\`, \`package.json\` - Config\n\nIf you need a code review, mention \`@claude\` in a comment.`
            });
