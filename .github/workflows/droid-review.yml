name: Droid Auto Review (Tier 3 - Deep Analysis)

on:
  workflow_run:
    workflows: [Route PR to Model]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
  actions: read

jobs:
  get-tier:
    runs-on: ubuntu-latest
    outputs:
      tier: ${{ steps.extract.outputs.tier }}
    steps:
      - name: Download routing artifacts
        uses: actions/download-artifact@v4
        with:
          name: routing-analysis
          github-token: ${{ github.token }}

      - name: Extract tier
        id: extract
        run: |
          if [ -f routing-analysis.json ]; then
            TIER=$(jq -r '.tier' routing-analysis.json)
            echo "tier=${TIER}" >> $GITHUB_OUTPUT
          else
            echo "tier=2" >> $GITHUB_OUTPUT
          fi

  droid-review:
    needs: get-tier
    if: |
      needs.get-tier.outputs.tier == '3' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.pull_request.draft == false &&
      (github.event.pull_request.author_association == 'OWNER' ||
       github.event.pull_request.author_association == 'MEMBER' ||
       github.event.pull_request.author_association == 'COLLABORATOR')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 20

      - name: Run Droid Auto Review (Tier 3: Deep Analysis)
        continue-on-error: true
        uses: Factory-AI/droid-action@v1
        with:
          factory_api_key: ${{ secrets.FACTORY_API_KEY }}
          automatic_review: true
