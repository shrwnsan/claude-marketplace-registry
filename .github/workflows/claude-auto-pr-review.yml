name: Claude Auto PR Review (Tier 2 - Standard)

on:
  workflow_run:
    workflows: [Route PR to Model]
    types: [completed]

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  get-tier:
    # Skip if not triggered by a PR workflow (e.g., Scan Marketplaces)
    if: github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest
    outputs:
      tier: ${{ steps.extract.outputs.tier }}
      reason: ${{ steps.extract.outputs.reason }}
      pr_number: ${{ steps.extract.outputs.pr_number }}
      author_association: ${{ steps.extract.outputs.author_association }}
      head_sha: ${{ steps.extract.outputs.head_sha }}
      is_draft: ${{ steps.extract.outputs.is_draft }}
    steps:
      - name: Download routing artifacts
        uses: actions/download-artifact@v4
        with:
          name: routing-analysis
          github-token: ${{ github.token }}

      - name: Extract tier and reason
        id: extract
        run: |
          if [ -f routing-analysis.json ]; then
            # Validate artifact contains required fields
            if ! jq -e '.tier and .reason' routing-analysis.json > /dev/null 2>&1; then
              echo "‚ö†Ô∏è Invalid routing-analysis.json structure, falling back to Tier 2"
              echo "tier=2" >> $GITHUB_OUTPUT
              echo "reason=Artifact validation failed, defaulting to Tier 2" >> $GITHUB_OUTPUT
            else
              TIER=$(jq -r '.tier' routing-analysis.json)
              REASON=$(jq -r '.reason' routing-analysis.json)
              echo "tier=${TIER}" >> $GITHUB_OUTPUT
              echo "reason=${REASON}" >> $GITHUB_OUTPUT
            fi
          else
            echo "tier=2" >> $GITHUB_OUTPUT
            echo "reason=Default to Tier 2" >> $GITHUB_OUTPUT
          fi

          # Extract author_association from routing artifact (workflow_run.pull_requests[] doesn't carry it)
          if [ -f routing-analysis.json ]; then
            AUTHOR_ASSOCIATION=$(jq -r '.author_association // "NONE"' routing-analysis.json)
          else
            AUTHOR_ASSOCIATION="NONE"
          fi
          echo "author_association=${AUTHOR_ASSOCIATION}" >> $GITHUB_OUTPUT

          # Extract PR details from workflow_run context
          PR_COUNT=$(jq -r '.workflow_run.pull_requests | length' "$GITHUB_EVENT_PATH")
          if [ "$PR_COUNT" -gt 0 ]; then
            PR_NUMBER=$(jq -r '.workflow_run.pull_requests[0].number' "$GITHUB_EVENT_PATH")
            HEAD_SHA=$(jq -r '.workflow_run.head_sha // ""' "$GITHUB_EVENT_PATH")
            IS_DRAFT=$(jq -r '.workflow_run.pull_requests[0].draft // "false"' "$GITHUB_EVENT_PATH")
            echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
            echo "head_sha=${HEAD_SHA}" >> $GITHUB_OUTPUT
            echo "is_draft=${IS_DRAFT}" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è No pull requests found in workflow_run event"
            echo "pr_number=0" >> $GITHUB_OUTPUT
            echo "head_sha=" >> $GITHUB_OUTPUT
            echo "is_draft=false" >> $GITHUB_OUTPUT
          fi

  auto-review:
    name: Claude Code Review (Tier 2)
    needs: get-tier
    # Only run for Tier 2 (standard) or fallback tier 2
    if: |
      needs.get-tier.result == 'success' &&
      (needs.get-tier.outputs.tier == '2' || needs.get-tier.outputs.tier == '') &&
      (needs.get-tier.outputs.author_association == 'OWNER' ||
       needs.get-tier.outputs.author_association == 'MEMBER' ||
       needs.get-tier.outputs.author_association == 'COLLABORATOR')
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.get-tier.outputs.head_sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check CI workflow status
        id: ci-status
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ needs.get-tier.outputs.pr_number }}', 10);

            if (!prNumber || prNumber === 0) {
              console.log('No PR number available, skipping CI status check');
              core.setOutput('status', 'unknown');
              core.setOutput('url', '');
              return;
            }

            // Get the PR to find the head ref
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci.yml',
              branch: pr.head.ref,
              per_page: 1
            });

            const latestRun = runs.data.workflow_runs && runs.data.workflow_runs.length > 0
              ? runs.data.workflow_runs[0]
              : null;
            const status = latestRun
              ? (latestRun.status === 'completed' ? latestRun.conclusion : 'pending')
              : 'not_run';

            core.setOutput('status', status);
            core.setOutput('url', latestRun?.html_url || '');

      - name: Run Code Review
        if: steps.ci-status.outputs.status == 'success'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          claude_args: |
            --allowedTools "Read,Write,Edit,Glob,Grep,Bash(npm:*),Bash(npx:*),Bash(git:*),Bash(node:*)"
            --max-turns 10
          settings: |
            {
              "instructions": "You are a code reviewer for a PR that changes critical paths.\n\nTier: 2 (Standard complexity)\nReason: ${{ needs.get-tier.outputs.reason }}\nCI Status: \"${{ steps.ci-status.outputs.status }}\"\nCI Workflow: ${{ steps.ci-status.outputs.url }}\n\nCI Status Handling:\n- 'failure': CRITICAL ISSUE - tests failing, must fix before approval\n- 'not_run': WARNING - CI hasn't run yet, recommend running tests first\n- 'pending': CI still running, review code but tests may fail\n- 'success': All tests passed, proceed with review\n\nAnalyze this PR for:\n\n1. **CI Test Results** (check above - handle based on status)\n2. **Security Issues** (OWASP Top 10, auth flaws, injection vulnerabilities)\n3. **Code Quality** (type safety, error handling, performance)\n4. **Best Practices** (framework patterns, project conventions)\n5. **Breaking Changes** (API changes, migration requirements)\n\nFormat your response as:\n\n## üö® Critical Issues (must fix)\n## ‚ö†Ô∏è Medium/Low Issues (should fix)\n## ‚úÖ Positive Findings\n## üìã Recommendation\n\nFinal line must be one of:\n- `APPROVED`\n- `NEEDS_CHANGES`\n- `REVIEW_REQUIRED`",
              "env": {
                "NODE_ENV": "test",
                "CI": "true"
              }
            }
        env:
          # Using api.z.ai proxy for cost optimization and rate limiting
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic

      - name: Post Skip Notice
        if: |
          needs.get-tier.outputs.is_draft == 'true' ||
          steps.ci-status.outputs.status != 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const isDraft = '${{ needs.get-tier.outputs.is_draft }}' === 'true';
            const ciStatus = '${{ steps.ci-status.outputs.status }}' || '';
            const tier = '${{ needs.get-tier.outputs.tier }}';
            const reason = '${{ needs.get-tier.outputs.reason }}';
            const prNumber = parseInt('${{ needs.get-tier.outputs.pr_number }}', 10);

            if (!prNumber || prNumber === 0) {
              console.log('No PR number available, skipping comment');
              return;
            }

            let skipReason = '';
            if (isDraft) {
              skipReason = 'This is a draft PR.';
            } else if (ciStatus !== 'success') {
              skipReason = `CI has not passed yet (status: ${ciStatus || 'unknown'}).`;
            }

            if (skipReason) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `### ‚ÑπÔ∏è Automated Review Skipped\n\n${skipReason}\n\n**PR Analysis:**\n- Tier: ${tier}\n- Reason: ${reason}\n\nIf you need a code review, mention \`@claude\` in a comment.`
              });
            }
