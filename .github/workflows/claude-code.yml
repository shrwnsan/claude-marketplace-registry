name: Claude Code Assistant

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize, reopened]
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  id-token: write

jobs:
  claude-code:
    name: Claude Code
    runs-on: ubuntu-latest
    # Only run when @claude is mentioned by members/collaborators
    if: |
      ((github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
       (github.event_name == 'pull_request' && contains(github.event.pull_request.body || '', '@claude')) ||
       (github.event_name == 'issues' && contains(github.event.issue.body || '', '@claude'))) &&
      (github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'OWNER' ||
       github.event.comment.author_association == 'COLLABORATOR' ||
       github.event.issue.author_association == 'MEMBER' ||
       github.event.issue.author_association == 'OWNER' ||
       github.event.issue.author_association == 'COLLABORATOR' ||
       github.event.pull_request.user.author_association == 'MEMBER' ||
       github.event.pull_request.user.author_association == 'OWNER' ||
       github.event.pull_request.user.author_association == 'COLLABORATOR')

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Claude Code Action
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          # Enable specific tools for this repo
          claude_args: |
            --allowedTools "Read,Write,Edit,NotebookEdit,Glob,Grep,Bash(npm:*),Bash(npx:*),Bash(git:*),Bash(node:*),TodoWrite,AskUserQuestion,WebSearch,WebFetch,mcp__web_reader__webReader"
            --max-turns 10
          # Optional: Add environment variables
          settings: |
            {
              "env": {
                "NODE_ENV": "test",
                "CI": "true"
              }
            }
        env:
          # Use custom API base URL for Z.ai
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
