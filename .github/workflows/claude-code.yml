name: Claude Code Assistant

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize, reopened]
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  id-token: write

jobs:
  pre-check:
    name: Pre-Check Validation
    runs-on: ubuntu-latest
    # Only run when @claude is mentioned by members/collaborators
    if: |
      ((github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
       (github.event_name == 'pull_request' && contains(github.event.pull_request.body || '', '@claude')) ||
       (github.event_name == 'issues' && contains(github.event.issue.body || '', '@claude'))) &&
      (github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'OWNER' ||
       github.event.comment.author_association == 'COLLABORATOR' ||
       github.event.issue.author_association == 'MEMBER' ||
       github.event.issue.author_association == 'OWNER' ||
       github.event.issue.author_association == 'COLLABORATOR' ||
       github.event.pull_request.user.author_association == 'MEMBER' ||
       github.event.pull_request.user.author_association == 'OWNER' ||
       github.event.pull_request.user.author_association == 'COLLABORATOR')

    outputs:
      lint-status: ${{ steps.lint.outputs.status }}
      format-status: ${{ steps.format.outputs.status }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint (continue on failure)
        id: lint
        run: |
          npm run lint 2>&1 | tee /tmp/lint.log
          LINT_EXIT_CODE=${PIPESTATUS[0]}
          if [ $LINT_EXIT_CODE -eq 0 ]; then
            echo "status=pass" >> $GITHUB_OUTPUT
          else
            echo "status=fail" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Check formatting (continue on failure)
        id: format
        run: |
          npm run format:check 2>&1 | tee /tmp/format.log
          FORMAT_EXIT_CODE=${PIPESTATUS[0]}
          if [ $FORMAT_EXIT_CODE -eq 0 ]; then
            echo "status=pass" >> $GITHUB_OUTPUT
          else
            echo "status=fail" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Upload lint results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pre-check-results
          path: |
            /tmp/lint.log
            /tmp/format.log
          retention-days: 1

  review:
    name: Code Review
    runs-on: ubuntu-latest
    needs: pre-check
    if: always() && needs.pre-check.result == 'success'

    outputs:
      review-artifact: ${{ steps.review.outputs.artifact_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download pre-check results
        uses: actions/download-artifact@v4
        with:
          name: pre-check-results
          path: /tmp
        continue-on-error: true

      - name: Run Code Review
        id: review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          claude_args: |
            --allowedTools "Read,Glob,Grep,WebSearch,WebFetch"
            --max-turns 10
          settings: |
            {
              "instructions": "You are a code reviewer for this PR.\n\nPre-check status:\n- ESLint: ${{ needs.pre-check.outputs.lint-status }}\n- Prettier: ${{ needs.pre-check.outputs.format-status }}\n\nAnalyze this PR for:\n1. Security Issues (OWASP Top 10, auth flaws, injection)\n2. Code Quality (type safety, error handling, performance)\n3. Best Practices (framework patterns, conventions)\n4. Breaking Changes (API changes, migration needed)\n\nCategorize findings by severity:\n- **critical**: Security vulnerabilities, crashes, data loss risks\n- **medium**: Code quality issues, missing error handling, performance concerns\n- **low**: Style inconsistencies, minor improvements, nice-to-haves\n\nOutput your findings as JSON to /tmp/review.json:\n{\n  \"critical\": [{\"location\": \"file:line\", \"issue\": \"description\", \"fix\": \"suggestion\"}],\n  \"medium\": [...],\n  \"low\": [...]\n}\n\nAlso provide a human-readable summary in a comment.",
              "env": {
                "NODE_ENV": "test",
                "CI": "true"
              }
            }
        env:
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic

      - name: Upload review results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: review-results
          path: /tmp/review.json
          retention-days: 1

  self-review:
    name: Review Validation
    runs-on: ubuntu-latest
    needs: [pre-check, review]
    if: always() && needs.review.result == 'success'

    outputs:
      validated-artifact: ${{ steps.validate.outputs.artifact_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download review results
        uses: actions/download-artifact@v4
        with:
          name: review-results
          path: /tmp

      - name: Validate Review
        id: validate
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          claude_args: |
            --allowedTools "Read,Glob,Grep,WebSearch,WebFetch"
            --max-turns 8
          settings: |
            {
              "instructions": "You are validating a code review.\n\nRead /tmp/review.json which contains:\n- critical: []\n- medium: []\n- low: []\n\nYour tasks:\n1. **Check for misses**: Look for issues the original review missed:\n   - OWASP Top 10 vulnerabilities\n   - Performance anti-patterns\n   - Breaking changes\n   - Type safety issues\n\n2. **Validate findings**: For each item in the original review:\n   - Is this a real issue? (not false positive)\n   - Is the location accurate?\n   - Is the severity correct?\n\n3. **Output merged results** to /tmp/validated-findings.json:\n{\n  \"validated\": {\n    \"critical\": [original items that passed validation],\n    \"medium\": [...],\n    \"low\": [...]\n  },\n  \"missed\": [issues you found that were missing],\n  \"false_positives\": [original items that are invalid]\n}",
              "env": {
                "NODE_ENV": "test",
                "CI": "true"
              }
            }
        env:
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic

      - name: Upload validated findings
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validated-findings
          path: /tmp/validated-findings.json
          retention-days: 1

  claude-code:
    name: Claude Code
    runs-on: ubuntu-latest
    needs: pre-check
    if: always() && needs.pre-check.result == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download pre-check results
        uses: actions/download-artifact@v4
        with:
          name: pre-check-results
          path: /tmp
        continue-on-error: true

      - name: Display pre-check status
        run: |
          echo "## Pre-Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint | ${{ needs.pre-check.outputs.lint-status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Prettier | ${{ needs.pre-check.outputs.format-status }} |" >> $GITHUB_STEP_SUMMARY

      - name: Claude Code Action
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          # Enable specific tools for this repo
          # Added npx:* to allow running prettier for auto-fixing
          claude_args: |
            --allowedTools "Read,Write,Edit,NotebookEdit,Glob,Grep,Bash(npm:*),Bash(npx:*),Bash(git:*),Bash(node:*),TodoWrite,AskUserQuestion,WebSearch,WebFetch,mcp__web_reader__webReader"
            # Increased from 10 to 15 to accommodate pre-check review + fixes + validation
            --max-turns 15
          # Optional: Add environment variables and instructions
          settings: |
            {
              "env": {
                "NODE_ENV": "test",
                "CI": "true"
              },
              "instructions": "Before making code changes, check the LINT_STATUS and FORMAT_STATUS environment variables to understand code quality. Use 'npx prettier --write' to auto-fix formatting issues when appropriate. Always run tests before committing."
            }
        env:
          # Use custom API base URL for Z.ai
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          # Pass pre-check status to Claude for context
          LINT_STATUS: ${{ needs.pre-check.outputs.lint-status }}
          FORMAT_STATUS: ${{ needs.pre-check.outputs.format-status }}
