name: Claude Code Assistant

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      # Only trigger on meaningful code changes
      - 'src/**/*.ts'
      - 'src/**/*.tsx'
      - 'pages/**/*.ts'
      - 'pages/**/*.tsx'
      - 'scripts/**/*.ts'
      - '.github/workflows/**/*.yml'
      # Ignore documentation, configs, and test artifacts
      - '!**/*.md'
      - '!**/*.json'
      - '!**/test-*.ts'
      - '!docs/**'
  issues:
    types: [opened, edited]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: number

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  id-token: write

jobs:
  pre-check:
    name: Pre-Check Validation
    runs-on: ubuntu-latest
    # Only run when @claude is mentioned by members/collaborators
    if: |
      ((github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
       (github.event_name == 'pull_request' && contains(github.event.pull_request.body || '', '@claude')) ||
       (github.event_name == 'issues' && contains(github.event.issue.body || '', '@claude'))) &&
      (github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'OWNER' ||
       github.event.comment.author_association == 'COLLABORATOR' ||
       github.event.issue.author_association == 'MEMBER' ||
       github.event.issue.author_association == 'OWNER' ||
       github.event.issue.author_association == 'COLLABORATOR' ||
       github.event.pull_request.user.author_association == 'MEMBER' ||
       github.event.pull_request.user.author_association == 'OWNER' ||
       github.event.pull_request.user.author_association == 'COLLABORATOR')

    outputs:
      lint-status: ${{ steps.lint.outputs.status }}
      format-status: ${{ steps.format.outputs.status }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint (continue on failure)
        id: lint
        run: |
          npm run lint 2>&1 | tee /tmp/lint.log
          LINT_EXIT_CODE=${PIPESTATUS[0]}
          if [ $LINT_EXIT_CODE -eq 0 ]; then
            echo "status=pass" >> $GITHUB_OUTPUT
          else
            echo "status=fail" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Check formatting (continue on failure)
        id: format
        run: |
          npm run format:check 2>&1 | tee /tmp/format.log
          FORMAT_EXIT_CODE=${PIPESTATUS[0]}
          if [ $FORMAT_EXIT_CODE -eq 0 ]; then
            echo "status=pass" >> $GITHUB_OUTPUT
          else
            echo "status=fail" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Upload lint results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pre-check-results
          path: |
            /tmp/lint.log
            /tmp/format.log
          retention-days: 1

  review:
    name: Code Review
    runs-on: ubuntu-latest
    needs: pre-check
    if: always() && needs.pre-check.result == 'success'

    outputs:
      review-artifact: ${{ steps.review.outputs.artifact_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download pre-check results
        uses: actions/download-artifact@v4
        with:
          name: pre-check-results
          path: /tmp
        continue-on-error: true

      - name: Generate timestamp
        id: timestamp
        run: echo "value=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Create output file
        run: |
          mkdir -p /tmp/claude-output
          echo '{"findingsMarkdown":"","findingsJson":[]}' > /tmp/claude-output/review-results.json

      - name: Run Code Review
        id: review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          claude_args: |
            --allowedTools "Read,Glob,Grep,WebSearch,WebFetch,Write,Bash(cat:*)"
            --max-turns 15
          settings: |
            {
              "instructions": "## CODE REVIEW TASK\\n\\nYou are reviewing PR #${{ github.event.pull_request.number || github.event.issue.number }}.\\n\\n### CRITICAL RULES - READ CAREFULLY\\n\\n1. **REVIEW THE CODE, NOT THE WORKFLOW** - Analyze the actual source code changes in this PR. Do NOT discuss the review process, workflow architecture, or how you are conducting the review.\\n\\n2. **BE CONCISE** - Each finding should be 2-3 sentences maximum. No lengthy explanations. No meta-commentary.\\n\\n3. **ONLY REPORT ACTUAL ISSUES** - Report bugs, security vulnerabilities, code quality problems. Do NOT report hypothetical concerns or suggestions for improvement unless they fix a real bug.\\n\\n4. **USE STRUCTURED FORMAT** - Write findings to JSON file, nothing else.\\n\\n### WHAT TO LOOK FOR\\n\\n- Security issues (injection, auth bypass, secrets exposure)\\n- Bugs (null refs, type errors, logic errors)\\n- Breaking changes (API changes, removed exports)\\n- Unused variables or imports\\n- Missing error handling for critical paths\\n\\n### OUTPUT FORMAT\\n\\nWrite to /tmp/claude-output/review-results.json:\\n\\n```json\\n{\\n  \\\"findingsMarkdown\\\": \\\"Brief summary of issues found\\\",\\n  \\\"findingsJson\\\": [\\n    {\\\"id\\\":\\\"F-001\\\",\\\"severity\\\":\\\"critical|medium|low\\\",\\\"category\\\":\\\"security|bug|quality\\\",\\\"file\\\":\\\"path/to/file.ts\\\",\\\"lineStart\\\":10,\\\"lineEnd\\\":15,\\\"title\\\":\\\"Brief title\\\",\\\"description\\\":\\\"What is wrong (1-2 sentences)\\\",\\\"recommendation\\\":\\\"How to fix (1 sentence)\\\"}\\n  ]\\n}\\n```\\n\\nIf no issues: `{\\\"findingsMarkdown\\\":\\\"No issues found.\\\",\\\"findingsJson\\\":[]}`\\n\\nAfter writing, run: cat /tmp/claude-output/review-results.json",
              "env": {
                "NODE_ENV": "test",
                "CI": "true",
                "PR_NUMBER": "${{ github.event.pull_request.number || github.event.issue.number }}"
              }
            }
        env:
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          GH_TOKEN: ${{ github.token }}

      - name: Post review comment
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || github.event.issue.number }}"
          RUN_ID="${{ github.run_id }}"
          TIMESTAMP="${{ steps.timestamp.outputs.value }}"

          # Read Claude's results
          if [ -f "/tmp/claude-output/review-results.json" ]; then
            FINDINGS_MD=$(jq -r '.findingsMarkdown // "No findings provided"' /tmp/claude-output/review-results.json)
            FINDINGS_JSON=$(jq -c '.findingsJson // []' /tmp/claude-output/review-results.json)

            # Build concise comment
            COMMENT_BODY=$(printf "## Code Review\n\n%s\n\n<!-- CLAUDE_PAYLOAD\n{\"version\":2,\"job\":\"review\",\"runId\":\"%s\",\"prNumber\":%s,\"timestamp\":\"%s\",\"findings\":%s}\nEND_PAYLOAD -->" "$FINDINGS_MD" "$RUN_ID" "$PR_NUMBER" "$TIMESTAMP" "$FINDINGS_JSON")

            # Post the comment
            gh pr comment "$PR_NUMBER" --body "$COMMENT_BODY"
          else
            echo "Warning: Claude output file not found"
            ls -la /tmp/claude-output/ || true
          fi

  self-review:
    name: Review Validation
    runs-on: ubuntu-latest
    needs: [pre-check, review]
    if: always() && needs.review.result == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fetch PR comments
        id: comments
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.issue.number || github.event.pull_request.number }}"
          echo "Fetching comments for PR #$PR_NUMBER"

          # Wait a moment to ensure previous job's comment is posted
          sleep 10

          # Get all comments from the review job (by claude bot)
          gh pr view "$PR_NUMBER" --json comments --jq \
            '.comments | map(select(.author.login == "claude")) | .[].body' \
            > /tmp/review-comments.txt

          echo "Fetched $(wc -l < /tmp/review-comments.txt) comment(s)"
          echo "=== Review Comments ==="
          cat /tmp/review-comments.txt
          echo "======================"

      - name: Generate timestamp
        id: timestamp
        run: echo "value=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Create output file
        run: |
          mkdir -p /tmp/claude-output
          echo '{"validationMarkdown":"","validatedFindings":[],"additionalFindings":[]}' > /tmp/claude-output/validation-results.json

      - name: Validate Review
        id: validate
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          claude_args: |
            --allowedTools "Read,Glob,Grep,WebSearch,WebFetch,Write,Bash(cat:*)"
            --max-turns 15
          settings: |
            {
              "instructions": "## VALIDATION TASK\\n\\nValidate findings from the code review for PR #${{ github.event.pull_request.number || github.event.issue.number }}.\\n\\n### CRITICAL RULES\\n\\n1. **NO META-COMMENTARY** - Do not discuss the validation process. Just validate and output results.\\n\\n2. **BE CONCISE** - Brief validation notes only.\\n\\n### STEPS\\n\\n1. Run: cat /tmp/review-comments.txt\\n2. Extract findingsJson from CLAUDE_PAYLOAD\\n3. For each finding: verify file/line exists, mark as validated:true or falsePositive:true\\n4. Check for missed issues\\n\\n### OUTPUT FORMAT\\n\\nWrite to /tmp/claude-output/validation-results.json:\\n\\n```json\\n{\\n  \\\"validationMarkdown\\\": \\\"N validated, M false positives, K additional\\\",\\n  \\\"validatedFindings\\\": [{...findings with validated:true or falsePositive:true...}],\\n  \\\"additionalFindings\\\": [{...missed issues in same format as review...}]\\n}\\n```\\n\\nAfter writing, run: cat /tmp/claude-output/validation-results.json",
              "env": {
                "NODE_ENV": "test",
                "CI": "true",
                "PR_NUMBER": "${{ github.event.pull_request.number || github.event.issue.number }}"
              }
            }
        env:
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          GH_TOKEN: ${{ github.token }}

      - name: Post validation comment
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || github.event.issue.number }}"
          RUN_ID="${{ github.run_id }}"
          TIMESTAMP="${{ steps.timestamp.outputs.value }}"

          # Read Claude's results
          if [ -f "/tmp/claude-output/validation-results.json" ]; then
            VALIDATION_MD=$(jq -r '.validationMarkdown // "No validation results provided"' /tmp/claude-output/validation-results.json)
            VALIDATED_JSON=$(jq -c '.validatedFindings // []' /tmp/claude-output/validation-results.json)
            ADDITIONAL_JSON=$(jq -c '.additionalFindings // []' /tmp/claude-output/validation-results.json)

            # Build concise comment
            COMMENT_BODY=$(printf "## Validation\n\n%s\n\n<!-- CLAUDE_PAYLOAD\n{\"version\":2,\"job\":\"validation\",\"runId\":\"%s\",\"prNumber\":%s,\"timestamp\":\"%s\",\"validatedFindings\":%s,\"additionalFindings\":%s}\nEND_PAYLOAD -->" "$VALIDATION_MD" "$RUN_ID" "$PR_NUMBER" "$TIMESTAMP" "$VALIDATED_JSON" "$ADDITIONAL_JSON")

            # Post the comment
            gh pr comment "$PR_NUMBER" --body "$COMMENT_BODY"
          else
            echo "Warning: Claude output file not found"
          fi

  triage:
    name: Finding Triage
    runs-on: ubuntu-latest
    needs: [pre-check, review, self-review]
    if: always() && needs.self-review.result == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fetch all PR comments
        id: comments
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.issue.number || github.event.pull_request.number }}"
          echo "Fetching all comments for PR #$PR_NUMBER"

          # Wait to ensure previous jobs' comments are posted
          sleep 10

          # Get all claude comments (review + self-review)
          gh pr view "$PR_NUMBER" --json comments --jq \
            '.comments | map(select(.author.login == "claude")) | .[].body' \
            > /tmp/all-review-comments.txt

          echo "Fetched $(wc -l < /tmp/all-review-comments.txt) comment(s)"
          echo "=== All Review Comments ==="
          cat /tmp/all-review-comments.txt
          echo "=========================="

      - name: Configure Git
        run: |
          git config --global user.name "claude-code[bot]"
          git config --global user.email "claude-code[bot]@users.noreply.github.com"

      - name: Generate timestamp
        id: timestamp
        run: echo "value=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Create output file
        run: |
          mkdir -p /tmp/claude-output
          echo '{"triageMarkdown":"","actions":[],"summary":{"criticalFixed":0,"issuesCreated":0,"skipped":0}}' > /tmp/claude-output/triage-results.json

      - name: Triage and Act
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          claude_args: |
            --allowedTools "Read,Write,Edit,Glob,Grep,Bash(npm:*),Bash(npx:*),Bash(git:add*),Bash(git:commit*),Bash(git:push),Bash(git:status*),Bash(git:diff*),Bash(git:config*),Bash(node:*),Bash(gh:*),Bash(cat:*)"
            --max-turns 20
          settings: |
            {
              "instructions": "## TRIAGE TASK\\n\\nProcess validated findings for PR #${{ github.event.pull_request.number || github.event.issue.number }}.\\n\\n### CRITICAL RULES\\n\\n1. **NO META-COMMENTARY** - Do not discuss the triage process. Just process and output results.\\n\\n2. **ACTION ONLY** - For each finding, take action or skip. No lengthy explanations.\\n\\n### STEPS\\n\\n1. Run: cat /tmp/all-review-comments.txt\\n2. Extract validatedFindings and additionalFindings from validation CLAUDE_PAYLOAD\\n3. Process each:\\n   - CRITICAL (validated): Fix code, run tests, commit, push\\n   - MEDIUM/LOW (validated): Create issue with gh issue create\\n   - False positives: Skip\\n\\n### OUTPUT FORMAT\\n\\nWrite to /tmp/claude-output/triage-results.json:\\n\\n```json\\n{\\n  \\\"triageMarkdown\\\": \\\"Fixed N critical, created M issues, skipped K\\\",\\n  \\\"actions\\\": [{\\\"findingId\\\":\\\"F-001\\\",\\\"action\\\":\\\"fixed|issue|skipped\\\",\\\"details\\\":\\\"Brief note\\\"}],\\n  \\\"summary\\\": {\\\"criticalFixed\\\":N,\\\"issuesCreated\\\":M,\\\"skipped\\\":K}\\n}\\n```\\n\\nAfter writing, run: cat /tmp/claude-output/triage-results.json",
              "env": {
                "NODE_ENV": "test",
                "CI": "true",
                "PR_NUMBER": "${{ github.event.pull_request.number || github.event.issue.number }}"
              }
            }
        env:
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          GH_TOKEN: ${{ github.token }}

      - name: Post triage comment
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || github.event.issue.number }}"
          RUN_ID="${{ github.run_id }}"
          SHA="${{ github.sha }}"
          TIMESTAMP="${{ steps.timestamp.outputs.value }}"

          # Read Claude's results
          if [ -f "/tmp/claude-output/triage-results.json" ]; then
            TRIAGE_MD=$(jq -r '.triageMarkdown // "No triage results provided"' /tmp/claude-output/triage-results.json)
            ACTIONS_JSON=$(jq -c '.actions // []' /tmp/claude-output/triage-results.json)
            SUMMARY_JSON=$(jq -c '.summary // {"criticalFixed":0,"issuesCreated":0,"skipped":0}' /tmp/claude-output/triage-results.json)

            # Build concise comment
            COMMENT_BODY=$(printf "## Triage\n\n%s\n\n<!-- CLAUDE_PAYLOAD\n{\"version\":2,\"job\":\"triage\",\"runId\":\"%s\",\"prNumber\":%s,\"sha\":\"%s\",\"timestamp\":\"%s\",\"actions\":%s,\"summary\":%s}\nEND_PAYLOAD -->" "$TRIAGE_MD" "$RUN_ID" "$PR_NUMBER" "$SHA" "$TIMESTAMP" "$ACTIONS_JSON" "$SUMMARY_JSON")

            # Post the comment
            gh pr comment "$PR_NUMBER" --body "$COMMENT_BODY"
          else
            echo "Warning: Claude output file not found"
          fi
