name: Claude Code Assistant

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize, reopened]
  issues:
    types: [opened, edited]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: number

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  id-token: write

jobs:
  pre-check:
    name: Pre-Check Validation
    runs-on: ubuntu-latest
    # Only run when @claude is mentioned by members/collaborators
    if: |
      ((github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
       (github.event_name == 'pull_request' && contains(github.event.pull_request.body || '', '@claude')) ||
       (github.event_name == 'issues' && contains(github.event.issue.body || '', '@claude'))) &&
      (github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'OWNER' ||
       github.event.comment.author_association == 'COLLABORATOR' ||
       github.event.issue.author_association == 'MEMBER' ||
       github.event.issue.author_association == 'OWNER' ||
       github.event.issue.author_association == 'COLLABORATOR' ||
       github.event.pull_request.user.author_association == 'MEMBER' ||
       github.event.pull_request.user.author_association == 'OWNER' ||
       github.event.pull_request.user.author_association == 'COLLABORATOR')

    outputs:
      lint-status: ${{ steps.lint.outputs.status }}
      format-status: ${{ steps.format.outputs.status }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint (continue on failure)
        id: lint
        run: |
          npm run lint 2>&1 | tee /tmp/lint.log
          LINT_EXIT_CODE=${PIPESTATUS[0]}
          if [ $LINT_EXIT_CODE -eq 0 ]; then
            echo "status=pass" >> $GITHUB_OUTPUT
          else
            echo "status=fail" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Check formatting (continue on failure)
        id: format
        run: |
          npm run format:check 2>&1 | tee /tmp/format.log
          FORMAT_EXIT_CODE=${PIPESTATUS[0]}
          if [ $FORMAT_EXIT_CODE -eq 0 ]; then
            echo "status=pass" >> $GITHUB_OUTPUT
          else
            echo "status=fail" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Upload lint results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pre-check-results
          path: |
            /tmp/lint.log
            /tmp/format.log
          retention-days: 1

  review:
    name: Code Review
    runs-on: ubuntu-latest
    needs: pre-check
    if: always() && needs.pre-check.result == 'success'

    outputs:
      review-artifact: ${{ steps.review.outputs.artifact_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download pre-check results
        uses: actions/download-artifact@v4
        with:
          name: pre-check-results
          path: /tmp
        continue-on-error: true

      - name: Generate timestamp
        id: timestamp
        run: echo "value=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Run Code Review
        id: review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          claude_args: |
            --allowedTools "Read,Glob,Grep,WebSearch,WebFetch,Bash(gh:*)"
            --max-turns 12
          settings: |
            {
              "instructions": "# ðŸ” CODE REVIEW (Job 1 of 3)\\n\\nCLAUDE_JOB=review\\n\\nPR: #${{ github.event.pull_request.number || github.event.issue.number }}\\nESLint: ${{ needs.pre-check.outputs.lint-status }} | Prettier: ${{ needs.pre-check.outputs.format-status }}\\n\\n## STEP 1: Analyze the PR\\n\\nReview for: Security (OWASP), Code Quality, Best Practices, Breaking Changes.\\n\\nFor each issue found, note: id (F-001, F-002...), severity (critical/medium/low), category, file, lineStart, lineEnd, title, description, recommendation.\\n\\n## STEP 2: EXECUTE THIS COMMAND\\n\\nAfter your analysis, you MUST execute the following gh command. Build the JSON findings array from your analysis and substitute it into FINDINGS_JSON.\\n\\n```\\ngh pr comment ${{ github.event.pull_request.number || github.event.issue.number }} --body \\\"## ðŸ” CODE REVIEW (Job 1/3)\\n\\nCLAUDE_JOB=review\\n\\n> **Run:** ${{ github.run_id }} | **Timestamp:** ${{ steps.timestamp.outputs.value }}\\n\\n### Findings\\n\\n[PASTE YOUR FINDINGS HERE AS MARKDOWN]\\n\\n---\\n\\n<!-- CLAUDE_PAYLOAD\\n{\\\\\\\"version\\\\\\\":1,\\\\\\\"job\\\\\\\":\\\\\\\"review\\\\\\\",\\\\\\\"runId\\\\\\\":\\\\\\\"${{ github.run_id }}\\\\\\\",\\\\\\\"prNumber\\\\\\\":${{ github.event.pull_request.number || github.event.issue.number }},\\\\\\\"timestamp\\\\\\\":\\\\\\\"${{ steps.timestamp.outputs.value }}\\\\\\\",\\\\\\\"findings\\\\\\\":[PASTE JSON ARRAY HERE]}\\nEND_PAYLOAD -->\\n\\n*ðŸ¤– Claude Code Review*\\\"\\n```\\n\\nIMPORTANT: Replace [PASTE JSON ARRAY HERE] with actual JSON like [{\\\\\\\"id\\\\\\\":\\\\\\\"F-001\\\\\\\",...}] or [] if none.\\nIMPORTANT: Replace [PASTE YOUR FINDINGS HERE AS MARKDOWN] with your actual findings.\\nIMPORTANT: Execute the command - do not just show it.",
              "env": {
                "NODE_ENV": "test",
                "CI": "true",
                "PR_NUMBER": "${{ github.event.pull_request.number || github.event.issue.number }}"
              }
            }
        env:
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          GH_TOKEN: ${{ github.token }}

  self-review:
    name: Review Validation
    runs-on: ubuntu-latest
    needs: [pre-check, review]
    if: always() && needs.review.result == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fetch PR comments
        id: comments
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.issue.number || github.event.pull_request.number }}"
          echo "Fetching comments for PR #$PR_NUMBER"

          # Wait a moment to ensure previous job's comment is posted
          sleep 10

          # Get all comments from the review job (by claude bot)
          gh pr view "$PR_NUMBER" --json comments --jq \
            '.comments | map(select(.author.login == "claude")) | .[].body' \
            > /tmp/review-comments.txt

          echo "Fetched $(wc -l < /tmp/review-comments.txt) comment(s)"
          echo "=== Review Comments ==="
          cat /tmp/review-comments.txt
          echo "======================"

      - name: Generate timestamp
        id: timestamp
        run: echo "value=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Validate Review
        id: validate
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          claude_args: |
            --allowedTools "Read,Glob,Grep,WebSearch,WebFetch,Bash(gh:*),Bash(cat:*)"
            --max-turns 15
          settings: |
            {
              "instructions": "# âœ… REVIEW VALIDATION (Job 2 of 3)\\n\\nCLAUDE_JOB=self-review\\n\\nPR: #${{ github.event.pull_request.number || github.event.issue.number }}\\n\\n## STEP 1: Extract Previous Findings\\n\\nRun: cat /tmp/review-comments.txt\\n\\nFind the CLAUDE_PAYLOAD block and parse the JSON to get the findings array.\\n\\n## STEP 2: Validate Each Finding\\n\\nFor each finding: verify file/line exists, confirm severity is appropriate, check if it's a false positive.\\n\\nMark each as validated:true or falsePositive:true.\\n\\nAlso check for any issues the review missed.\\n\\n## STEP 3: EXECUTE THIS COMMAND\\n\\nBuild your validated findings and additional findings arrays, then execute:\\n\\n```\\ngh pr comment ${{ github.event.pull_request.number || github.event.issue.number }} --body \\\"## âœ… REVIEW VALIDATION (Job 2/3)\\n\\nCLAUDE_JOB=self-review\\n\\n> **Run:** ${{ github.run_id }} | **Timestamp:** ${{ steps.timestamp.outputs.value }}\\n\\n### Validation Results\\n\\n- Validated: X findings confirmed\\n- False Positives: Y findings rejected\\n- Additional Issues: Z new issues found\\n\\n---\\n\\n<!-- CLAUDE_PAYLOAD\\n{\\\\\\\"version\\\\\\\":1,\\\\\\\"job\\\\\\\":\\\\\\\"validation\\\\\\\",\\\\\\\"runId\\\\\\\":\\\\\\\"${{ github.run_id }}\\\\\\\",\\\\\\\"prNumber\\\\\\\":${{ github.event.pull_request.number || github.event.issue.number }},\\\\\\\"timestamp\\\\\\\":\\\\\\\"${{ steps.timestamp.outputs.value }}\\\\\\\",\\\\\\\"validatedFindings\\\\\\\":[PASTE VALIDATED ARRAY],\\\\\\\"additionalFindings\\\\\\\":[PASTE ADDITIONAL ARRAY]}\\nEND_PAYLOAD -->\\n\\n*ðŸ¤– Claude Code Review*\\\"\\n```\\n\\nIMPORTANT: Replace [PASTE VALIDATED ARRAY] and [PASTE ADDITIONAL ARRAY] with actual JSON arrays.\\nIMPORTANT: Execute the command - do not just show it.",
              "env": {
                "NODE_ENV": "test",
                "CI": "true",
                "PR_NUMBER": "${{ github.event.pull_request.number || github.event.issue.number }}"
              }
            }
        env:
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          GH_TOKEN: ${{ github.token }}

  triage:
    name: Finding Triage
    runs-on: ubuntu-latest
    needs: [pre-check, review, self-review]
    if: always() && needs.self-review.result == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fetch all PR comments
        id: comments
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.issue.number || github.event.pull_request.number }}"
          echo "Fetching all comments for PR #$PR_NUMBER"

          # Wait to ensure previous jobs' comments are posted
          sleep 10

          # Get all claude comments (review + self-review)
          gh pr view "$PR_NUMBER" --json comments --jq \
            '.comments | map(select(.author.login == "claude")) | .[].body' \
            > /tmp/all-review-comments.txt

          echo "Fetched $(wc -l < /tmp/all-review-comments.txt) comment(s)"
          echo "=== All Review Comments ==="
          cat /tmp/all-review-comments.txt
          echo "=========================="

      - name: Configure Git
        run: |
          git config --global user.name "claude-code[bot]"
          git config --global user.email "claude-code[bot]@users.noreply.github.com"

      - name: Generate timestamp
        id: timestamp
        run: echo "value=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Triage and Act
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          claude_args: |
            --allowedTools "Read,Write,Edit,Glob,Grep,Bash(npm:*),Bash(npx:*),Bash(git:add*),Bash(git:commit*),Bash(git:push),Bash(git:status*),Bash(git:diff*),Bash(git:config*),Bash(node:*),Bash(gh:*),Bash(cat:*)"
            --max-turns 20
          settings: |
            {
              "instructions": "# ðŸŽ¯ TRIAGE (Job 3 of 3)\\n\\nCLAUDE_JOB=triage\\n\\nPR: #${{ github.event.pull_request.number || github.event.issue.number }}\\n\\n## STEP 1: Get Validated Findings\\n\\nRun: cat /tmp/all-review-comments.txt\\n\\nFind the validation job's CLAUDE_PAYLOAD block and extract validatedFindings and additionalFindings.\\n\\n## STEP 2: Process Each Finding\\n\\n- CRITICAL (not false positive): Fix code, run tests, commit, push\\n- MEDIUM/LOW (not false positive): Create issue with gh issue create\\n- False positives: Skip and record\\n\\n## STEP 3: EXECUTE THIS COMMAND\\n\\nAfter processing, execute this command with your actual data:\\n\\n```\\ngh pr comment ${{ github.event.pull_request.number || github.event.issue.number }} --body \\\"## ðŸŽ¯ TRIAGE (Job 3/3)\\n\\nCLAUDE_JOB=triage\\n\\n> **Run:** ${{ github.run_id }} | **SHA:** ${{ github.sha }} | **Timestamp:** ${{ steps.timestamp.outputs.value }}\\n\\n### Summary\\n\\n| Metric | Count |\\n|--------|-------|\\n| Critical Fixed | N |\\n| Issues Created | N |\\n| Skipped | N |\\n\\n### Actions\\n\\n| Finding | Action | Result |\\n|---------|--------|--------|\\n| F-XXX | fixed/issue/skipped | details |\\n\\n---\\n\\n<!-- CLAUDE_PAYLOAD\\n{\\\\\\\"version\\\\\\\":1,\\\\\\\"job\\\\\\\":\\\\\\\"triage\\\\\\\",\\\\\\\"runId\\\\\\\":\\\\\\\"${{ github.run_id }}\\\\\\\",\\\\\\\"prNumber\\\\\\\":${{ github.event.pull_request.number || github.event.issue.number }},\\\\\\\"sha\\\\\\\":\\\\\\\"${{ github.sha }}\\\\\\\",\\\\\\\"timestamp\\\\\\\":\\\\\\\"${{ steps.timestamp.outputs.value }}\\\\\\\",\\\\\\\"actions\\\\\\\":[PASTE ACTIONS ARRAY],\\\\\\\"summary\\\\\\\":{\\\\\\\"criticalFixed\\\\\\\":N,\\\\\\\"issuesCreated\\\\\\\":N,\\\\\\\"skipped\\\\\\\":N}}\\nEND_PAYLOAD -->\\n\\n*ðŸ¤– Claude Code Review*\\\"\\n```\\n\\nIMPORTANT: Replace [PASTE ACTIONS ARRAY] with your actual actions array and N with counts.\\nIMPORTANT: Execute the command - do not just show it.",
              "env": {
                "NODE_ENV": "test",
                "CI": "true",
                "PR_NUMBER": "${{ github.event.pull_request.number || github.event.issue.number }}"
              }
            }
        env:
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          GH_TOKEN: ${{ github.token }}
