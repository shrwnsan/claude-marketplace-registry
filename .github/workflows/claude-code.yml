name: Claude Code Assistant

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize, reopened]
  issues:
    types: [opened, edited]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: number

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  id-token: write

jobs:
  pre-check:
    name: Pre-Check Validation
    runs-on: ubuntu-latest
    # Only run when @claude is mentioned by members/collaborators
    if: |
      ((github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
       (github.event_name == 'pull_request' && contains(github.event.pull_request.body || '', '@claude')) ||
       (github.event_name == 'issues' && contains(github.event.issue.body || '', '@claude'))) &&
      (github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'OWNER' ||
       github.event.comment.author_association == 'COLLABORATOR' ||
       github.event.issue.author_association == 'MEMBER' ||
       github.event.issue.author_association == 'OWNER' ||
       github.event.issue.author_association == 'COLLABORATOR' ||
       github.event.pull_request.user.author_association == 'MEMBER' ||
       github.event.pull_request.user.author_association == 'OWNER' ||
       github.event.pull_request.user.author_association == 'COLLABORATOR')

    outputs:
      lint-status: ${{ steps.lint.outputs.status }}
      format-status: ${{ steps.format.outputs.status }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint (continue on failure)
        id: lint
        run: |
          npm run lint 2>&1 | tee /tmp/lint.log
          LINT_EXIT_CODE=${PIPESTATUS[0]}
          if [ $LINT_EXIT_CODE -eq 0 ]; then
            echo "status=pass" >> $GITHUB_OUTPUT
          else
            echo "status=fail" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Check formatting (continue on failure)
        id: format
        run: |
          npm run format:check 2>&1 | tee /tmp/format.log
          FORMAT_EXIT_CODE=${PIPESTATUS[0]}
          if [ $FORMAT_EXIT_CODE -eq 0 ]; then
            echo "status=pass" >> $GITHUB_OUTPUT
          else
            echo "status=fail" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Upload lint results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pre-check-results
          path: |
            /tmp/lint.log
            /tmp/format.log
          retention-days: 1

  review:
    name: Code Review
    runs-on: ubuntu-latest
    needs: pre-check
    if: always() && needs.pre-check.result == 'success'

    outputs:
      review-artifact: ${{ steps.review.outputs.artifact_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download pre-check results
        uses: actions/download-artifact@v4
        with:
          name: pre-check-results
          path: /tmp
        continue-on-error: true

      - name: Generate timestamp
        id: timestamp
        run: echo "value=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Create output file
        run: |
          mkdir -p /tmp/claude-output
          echo '{"findingsMarkdown":"","findingsJson":[]}' > /tmp/claude-output/review-results.json

      - name: Run Code Review
        id: review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          claude_args: |
            --allowedTools "Read,Glob,Grep,WebSearch,WebFetch,Write,Bash(cat:*)"
            --max-turns 15
          settings: |
            {
              "instructions": "# üîç CODE REVIEW (Job 1 of 3)\\n\\nCLAUDE_JOB=review\\n\\nPR: #${{ github.event.pull_request.number || github.event.issue.number }}\\nESLint: ${{ needs.pre-check.outputs.lint-status }} | Prettier: ${{ needs.pre-check.outputs.format-status }}\\n\\n## TASK: Analyze and Write Results\\n\\nReview the PR for: Security (OWASP), Code Quality, Best Practices, Breaking Changes.\\n\\nFor each issue found, note: id (F-001, F-002...), severity (critical/medium/low), category, file, lineStart, lineEnd, title, description, recommendation.\\n\\n## CRITICAL: Write Your Results\\n\\nYou MUST write your results to /tmp/claude-output/review-results.json in this exact format:\\n\\n```json\\n{\\n  \\\"findingsMarkdown\\\": \\\"Your detailed findings in markdown format\\\",\\n  \\\"findingsJson\\\": [\\n    {\\\"id\\\":\\\"F-001\\\",\\\"severity\\\":\\\"critical\\\",\\\"category\\\":\\\"security\\\",\\\"file\\\":\\\"src/example.ts\\\",\\\"lineStart\\\":10,\\\"lineEnd\\\":15,\\\"title\\\":\\\"Issue title\\\",\\\"description\\\":\\\"Description\\\",\\\"recommendation\\\":\\\"Fix recommendation\\\"}\\n  ]\\n}\\n```\\n\\nUse the Write tool to create/update /tmp/claude-output/review-results.json with your actual findings.\\n\\nIf no issues found, use findingsJson: [] and findingsMarkdown: \\\"No issues found.\\\"\\n\\nAfter writing the file, run: cat /tmp/claude-output/review-results.json to confirm.",
              "env": {
                "NODE_ENV": "test",
                "CI": "true",
                "PR_NUMBER": "${{ github.event.pull_request.number || github.event.issue.number }}"
              }
            }
        env:
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          GH_TOKEN: ${{ github.token }}

      - name: Post review comment
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || github.event.issue.number }}"
          RUN_ID="${{ github.run_id }}"
          TIMESTAMP="${{ steps.timestamp.outputs.value }}"

          # Read Claude's results
          if [ -f "/tmp/claude-output/review-results.json" ]; then
            FINDINGS_MD=$(jq -r '.findingsMarkdown // "No findings provided"' /tmp/claude-output/review-results.json)
            FINDINGS_JSON=$(jq -c '.findingsJson // []' /tmp/claude-output/review-results.json)

            # Build the comment body (using heredoc for multi-line)
            COMMENT_BODY=$(cat <<EOF
            ## üîç CODE REVIEW (Job 1/3)

            CLAUDE_JOB=review

            > **Run:** $RUN_ID | **Timestamp:** $TIMESTAMP

            ### Findings

            $FINDINGS_MD

            ---

            <!-- CLAUDE_PAYLOAD
            {"version":1,"job":"review","runId":"$RUN_ID","prNumber":$PR_NUMBER,"timestamp":"$TIMESTAMP","findings":$FINDINGS_JSON}
            END_PAYLOAD -->

            *ü§ñ Claude Code Review*
            EOF
            )

            # Post the comment
            gh pr comment "$PR_NUMBER" --body "$COMMENT_BODY"
          else
            echo "Warning: Claude output file not found"
            ls -la /tmp/claude-output/ || true
          fi

  self-review:
    name: Review Validation
    runs-on: ubuntu-latest
    needs: [pre-check, review]
    if: always() && needs.review.result == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fetch PR comments
        id: comments
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.issue.number || github.event.pull_request.number }}"
          echo "Fetching comments for PR #$PR_NUMBER"

          # Wait a moment to ensure previous job's comment is posted
          sleep 10

          # Get all comments from the review job (by claude bot)
          gh pr view "$PR_NUMBER" --json comments --jq \
            '.comments | map(select(.author.login == "claude")) | .[].body' \
            > /tmp/review-comments.txt

          echo "Fetched $(wc -l < /tmp/review-comments.txt) comment(s)"
          echo "=== Review Comments ==="
          cat /tmp/review-comments.txt
          echo "======================"

      - name: Generate timestamp
        id: timestamp
        run: echo "value=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Create output file
        run: |
          mkdir -p /tmp/claude-output
          echo '{"validationMarkdown":"","validatedFindings":[],"additionalFindings":[]}' > /tmp/claude-output/validation-results.json

      - name: Validate Review
        id: validate
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          claude_args: |
            --allowedTools "Read,Glob,Grep,WebSearch,WebFetch,Write,Bash(cat:*)"
            --max-turns 15
          settings: |
            {
              "instructions": "# ‚úÖ REVIEW VALIDATION (Job 2 of 3)\\n\\nCLAUDE_JOB=self-review\\n\\nPR: #${{ github.event.pull_request.number || github.event.issue.number }}\\n\\n## STEP 1: Extract Previous Findings\\n\\nRun: cat /tmp/review-comments.txt\\n\\nFind the CLAUDE_PAYLOAD block and parse the JSON to get the findings array.\\n\\n## STEP 2: Validate Each Finding\\n\\nFor each finding: verify file/line exists, confirm severity is appropriate, check if it's a false positive.\\n\\nMark each as validated:true or falsePositive:true.\\n\\nAlso check for any issues the review missed.\\n\\n## CRITICAL: Write Your Results\\n\\nYou MUST write your results to /tmp/claude-output/validation-results.json in this exact format:\\n\\n```json\\n{\\n  \\\"validationMarkdown\\\": \\\"Your validation summary in markdown\\\",\\n  \\\"validatedFindings\\\": [{...validated findings...}],\\n  \\\"additionalFindings\\\": [{...additional findings...}]\\n}\\n```\\n\\nUse the Write tool to create/update /tmp/claude-output/validation-results.json with your actual validation results.\\n\\nAfter writing the file, run: cat /tmp/claude-output/validation-results.json to confirm.",
              "env": {
                "NODE_ENV": "test",
                "CI": "true",
                "PR_NUMBER": "${{ github.event.pull_request.number || github.event.issue.number }}"
              }
            }
        env:
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          GH_TOKEN: ${{ github.token }}

      - name: Post validation comment
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || github.event.issue.number }}"
          RUN_ID="${{ github.run_id }}"
          TIMESTAMP="${{ steps.timestamp.outputs.value }}"

          # Read Claude's results
          if [ -f "/tmp/claude-output/validation-results.json" ]; then
            VALIDATION_MD=$(jq -r '.validationMarkdown // "No validation results provided"' /tmp/claude-output/validation-results.json)
            VALIDATED_JSON=$(jq -c '.validatedFindings // []' /tmp/claude-output/validation-results.json)
            ADDITIONAL_JSON=$(jq -c '.additionalFindings // []' /tmp/claude-output/validation-results.json)

            # Build the comment body
            COMMENT_BODY=$(cat <<EOF
            ## ‚úÖ REVIEW VALIDATION (Job 2/3)

            CLAUDE_JOB=self-review

            > **Run:** $RUN_ID | **Timestamp:** $TIMESTAMP

            ### Validation Results

            $VALIDATION_MD

            ---

            <!-- CLAUDE_PAYLOAD
            {"version":1,"job":"validation","runId":"$RUN_ID","prNumber":$PR_NUMBER,"timestamp":"$TIMESTAMP","validatedFindings":$VALIDATED_JSON,"additionalFindings":$ADDITIONAL_JSON}
            END_PAYLOAD -->

            *ü§ñ Claude Code Review*
            EOF
            )

            # Post the comment
            gh pr comment "$PR_NUMBER" --body "$COMMENT_BODY"
          else
            echo "Warning: Claude output file not found"
          fi

  triage:
    name: Finding Triage
    runs-on: ubuntu-latest
    needs: [pre-check, review, self-review]
    if: always() && needs.self-review.result == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fetch all PR comments
        id: comments
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.issue.number || github.event.pull_request.number }}"
          echo "Fetching all comments for PR #$PR_NUMBER"

          # Wait to ensure previous jobs' comments are posted
          sleep 10

          # Get all claude comments (review + self-review)
          gh pr view "$PR_NUMBER" --json comments --jq \
            '.comments | map(select(.author.login == "claude")) | .[].body' \
            > /tmp/all-review-comments.txt

          echo "Fetched $(wc -l < /tmp/all-review-comments.txt) comment(s)"
          echo "=== All Review Comments ==="
          cat /tmp/all-review-comments.txt
          echo "=========================="

      - name: Configure Git
        run: |
          git config --global user.name "claude-code[bot]"
          git config --global user.email "claude-code[bot]@users.noreply.github.com"

      - name: Generate timestamp
        id: timestamp
        run: echo "value=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Create output file
        run: |
          mkdir -p /tmp/claude-output
          echo '{"triageMarkdown":"","actions":[],"summary":{"criticalFixed":0,"issuesCreated":0,"skipped":0}}' > /tmp/claude-output/triage-results.json

      - name: Triage and Act
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          claude_args: |
            --allowedTools "Read,Write,Edit,Glob,Grep,Bash(npm:*),Bash(npx:*),Bash(git:add*),Bash(git:commit*),Bash(git:push),Bash(git:status*),Bash(git:diff*),Bash(git:config*),Bash(node:*),Bash(gh:*),Bash(cat:*)"
            --max-turns 20
          settings: |
            {
              "instructions": "# üéØ TRIAGE (Job 3 of 3)\\n\\nCLAUDE_JOB=triage\\n\\nPR: #${{ github.event.pull_request.number || github.event.issue.number }}\\n\\n## STEP 1: Get Validated Findings\\n\\nRun: cat /tmp/all-review-comments.txt\\n\\nFind the validation job's CLAUDE_PAYLOAD block and extract validatedFindings and additionalFindings.\\n\\n## STEP 2: Process Each Finding\\n\\n- CRITICAL (not false positive): Fix code, run tests, commit, push\\n- MEDIUM/LOW (not false positive): Create issue with gh issue create\\n- False positives: Skip and record\\n\\n## CRITICAL: Write Your Results\\n\\nAfter processing, you MUST write your results to /tmp/claude-output/triage-results.json in this exact format:\\n\\n```json\\n{\\n  \\\"triageMarkdown\\\": \\\"Your triage summary in markdown\\\",\\n  \\\"actions\\\": [{\\\"findingId\\\":\\\"F-001\\\",\\\"action\\\":\\\"fixed/issue/skipped\\\",\\\"details\\\":\\\"Description\\\"}],\\n  \\\"summary\\\": {\\\"criticalFixed\\\":N,\\\"issuesCreated\\\":N,\\\"skipped\\\":N}\\n}\\n```\\n\\nUse the Write tool to create/update /tmp/claude-output/triage-results.json with your actual triage results.\\n\\nAfter writing the file, run: cat /tmp/claude-output/triage-results.json to confirm.",
              "env": {
                "NODE_ENV": "test",
                "CI": "true",
                "PR_NUMBER": "${{ github.event.pull_request.number || github.event.issue.number }}"
              }
            }
        env:
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          GH_TOKEN: ${{ github.token }}

      - name: Post triage comment
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || github.event.issue.number }}"
          RUN_ID="${{ github.run_id }}"
          SHA="${{ github.sha }}"
          TIMESTAMP="${{ steps.timestamp.outputs.value }}"

          # Read Claude's results
          if [ -f "/tmp/claude-output/triage-results.json" ]; then
            TRIAGE_MD=$(jq -r '.triageMarkdown // "No triage results provided"' /tmp/claude-output/triage-results.json)
            ACTIONS_JSON=$(jq -c '.actions // []' /tmp/claude-output/triage-results.json)
            SUMMARY_JSON=$(jq -c '.summary // {"criticalFixed":0,"issuesCreated":0,"skipped":0}' /tmp/claude-output/triage-results.json)

            # Build the comment body
            COMMENT_BODY=$(cat <<EOF
            ## üéØ TRIAGE (Job 3/3)

            CLAUDE_JOB=triage

            > **Run:** $RUN_ID | **SHA:** $SHA | **Timestamp:** $TIMESTAMP

            ### Summary

            $TRIAGE_MD

            ---

            <!-- CLAUDE_PAYLOAD
            {"version":1,"job":"triage","runId":"$RUN_ID","prNumber":$PR_NUMBER,"sha":"$SHA","timestamp":"$TIMESTAMP","actions":$ACTIONS_JSON,"summary":$SUMMARY_JSON}
            END_PAYLOAD -->

            *ü§ñ Claude Code Review*
            EOF
            )

            # Post the comment
            gh pr comment "$PR_NUMBER" --body "$COMMENT_BODY"
          else
            echo "Warning: Claude output file not found"
          fi
