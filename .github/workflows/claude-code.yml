name: Claude Code Assistant

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize, reopened]
  issues:
    types: [opened, edited]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: number

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  id-token: write

jobs:
  pre-check:
    name: Pre-Check Validation
    runs-on: ubuntu-latest
    # Only run when @claude is mentioned by members/collaborators
    if: |
      ((github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
       (github.event_name == 'pull_request' && contains(github.event.pull_request.body || '', '@claude')) ||
       (github.event_name == 'issues' && contains(github.event.issue.body || '', '@claude'))) &&
      (github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'OWNER' ||
       github.event.comment.author_association == 'COLLABORATOR' ||
       github.event.issue.author_association == 'MEMBER' ||
       github.event.issue.author_association == 'OWNER' ||
       github.event.issue.author_association == 'COLLABORATOR' ||
       github.event.pull_request.user.author_association == 'MEMBER' ||
       github.event.pull_request.user.author_association == 'OWNER' ||
       github.event.pull_request.user.author_association == 'COLLABORATOR')

    outputs:
      lint-status: ${{ steps.lint.outputs.status }}
      format-status: ${{ steps.format.outputs.status }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint (continue on failure)
        id: lint
        run: |
          npm run lint 2>&1 | tee /tmp/lint.log
          LINT_EXIT_CODE=${PIPESTATUS[0]}
          if [ $LINT_EXIT_CODE -eq 0 ]; then
            echo "status=pass" >> $GITHUB_OUTPUT
          else
            echo "status=fail" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Check formatting (continue on failure)
        id: format
        run: |
          npm run format:check 2>&1 | tee /tmp/format.log
          FORMAT_EXIT_CODE=${PIPESTATUS[0]}
          if [ $FORMAT_EXIT_CODE -eq 0 ]; then
            echo "status=pass" >> $GITHUB_OUTPUT
          else
            echo "status=fail" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Upload lint results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pre-check-results
          path: |
            /tmp/lint.log
            /tmp/format.log
          retention-days: 1

  review:
    name: Code Review
    runs-on: ubuntu-latest
    needs: pre-check
    if: always() && needs.pre-check.result == 'success'

    outputs:
      review-artifact: ${{ steps.review.outputs.artifact_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download pre-check results
        uses: actions/download-artifact@v4
        with:
          name: pre-check-results
          path: /tmp
        continue-on-error: true

      - name: Run Code Review
        id: review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          claude_args: |
            --allowedTools "Read,Glob,Grep,WebSearch,WebFetch,Bash(gh:*),Bash(date:*)"
            --max-turns 12
          settings: |
            {
              "instructions": "# ðŸ” CODE REVIEW (Job 1 of 3)\\n\\nYou are performing automated code review for PR #${{ github.event.pull_request.number || github.event.issue.number }}.\\n\\n## Pre-check Status\\n- ESLint: ${{ needs.pre-check.outputs.lint-status }}\\n- Prettier: ${{ needs.pre-check.outputs.format-status }}\\n\\n## Your Task\\n\\nAnalyze this PR for:\\n1. **Security Issues** (OWASP Top 10, auth flaws, injection)\\n2. **Code Quality** (type safety, error handling, performance)\\n3. **Best Practices** (framework patterns, conventions)\\n4. **Breaking Changes** (API changes, migration needed)\\n\\n## Output Format\\n\\nFor each finding, create a structured object with:\\n- `id`: Sequential ID (F-001, F-002, etc.)\\n- `severity`: critical | medium | low\\n- `category`: security | quality | performance | breaking-change | style\\n- `file`: exact file path\\n- `lineStart` / `lineEnd`: line numbers\\n- `title`: brief summary\\n- `description`: detailed explanation\\n- `recommendation`: how to fix\\n\\n## CRITICAL: Post Your Own Comment\\n\\nThe claude-code-action posts its own comment, but it's not clearly branded. You MUST post a SEPARATE, clearly-branded comment using `gh pr comment`.\\n\\nGet the current timestamp first:\\n```bash\\nTIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)\\n```\\n\\nThen post your branded comment:\\n```bash\\ngh pr comment ${{ github.event.pull_request.number || github.event.issue.number }} --body '## ðŸ” CODE REVIEW (Job 1/3)\\n\\n> **Job:** Code Review | **Run:** ${{ github.run_id }} | **Status:** Complete\\n\\n---\\n\\n### Findings\\n\\n[YOUR FINDINGS HERE - organized by severity: Critical > Medium > Low]\\n\\n---\\n\\n<!-- CLAUDE_PAYLOAD\\n{\"version\":1,\"job\":\"review\",\"runId\":\"${{ github.run_id }}\",\"prNumber\":${{ github.event.pull_request.number || github.event.issue.number }},\"timestamp\":\"'\"$TIMESTAMP\"'\",\"findings\":[YOUR_FINDINGS_ARRAY]}\\nEND_PAYLOAD -->\\n\\n*ðŸ¤– Automated by Claude Code Review Workflow*'\\n```\\n\\nREPLACE `[YOUR FINDINGS HERE]` with your actual findings formatted as markdown.\\nREPLACE `YOUR_FINDINGS_ARRAY` with the actual JSON array of your findings.\\n\\nIf no issues found, still post the comment with \\\"No issues found\\\" and an empty findings array.",
              "env": {
                "NODE_ENV": "test",
                "CI": "true",
                "PR_NUMBER": "${{ github.event.pull_request.number || github.event.issue.number }}"
              }
            }
        env:
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          GH_TOKEN: ${{ github.token }}

  self-review:
    name: Review Validation
    runs-on: ubuntu-latest
    needs: [pre-check, review]
    if: always() && needs.review.result == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fetch PR comments
        id: comments
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.issue.number || github.event.pull_request.number }}"
          echo "Fetching comments for PR #$PR_NUMBER"

          # Wait a moment to ensure previous job's comment is posted
          sleep 10

          # Get all comments from the review job (by claude bot)
          gh pr view "$PR_NUMBER" --json comments --jq \
            '.comments | map(select(.author.login == "claude")) | .[].body' \
            > /tmp/review-comments.txt

          echo "Fetched $(wc -l < /tmp/review-comments.txt) comment(s)"
          echo "=== Review Comments ==="
          cat /tmp/review-comments.txt
          echo "======================"

      - name: Validate Review
        id: validate
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          claude_args: |
            --allowedTools "Read,Glob,Grep,WebSearch,WebFetch,Bash(gh:*),Bash(date:*),Bash(cat:*)"
            --max-turns 15
          settings: |
            {
              "instructions": "# âœ… REVIEW VALIDATION (Job 2 of 3)\\n\\nYou are validating the code review findings from Job 1 for PR #${{ github.event.pull_request.number || github.event.issue.number }}.\\n\\n## Step 1: Read Previous Review\\n\\nRead /tmp/review-comments.txt to find the Code Review comment from Job 1.\\nLook for the `<!-- CLAUDE_PAYLOAD` block and extract the JSON.\\n\\n## Step 2: Validate Each Finding\\n\\nFor each finding in the payload:\\n1. **Verify location**: Does the issue exist at the stated file/line?\\n2. **Confirm severity**: Is critical/medium/low appropriate?\\n3. **Check for false positives**: Is this actually a problem?\\n4. Set `validated: true` if confirmed, `falsePositive: true` if not real\\n\\n## Step 3: Check for Missed Issues\\n\\nAlso look for issues the original review missed:\\n- OWASP Top 10 vulnerabilities\\n- Performance anti-patterns\\n- Breaking changes\\n- Type safety issues\\n\\n## CRITICAL: Post Your Own Branded Comment\\n\\nGet timestamp and post a SEPARATE branded comment:\\n```bash\\nTIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)\\nSOURCE_RUN_ID=\\\"extracted-from-job1-payload\\\"\\n\\ngh pr comment ${{ github.event.pull_request.number || github.event.issue.number }} --body '## âœ… REVIEW VALIDATION (Job 2/3)\\n\\n> **Job:** Validation | **Run:** ${{ github.run_id }} | **Source Run:** '\\\"$SOURCE_RUN_ID\\\"'\\n\\n---\\n\\n### Validation Results\\n\\n[YOUR VALIDATION RESULTS - which findings are confirmed vs false positives]\\n\\n### Additional Issues Found\\n\\n[ANY NEW ISSUES YOU DISCOVERED]\\n\\n---\\n\\n<!-- CLAUDE_PAYLOAD\\n{\"version\":1,\"job\":\"validation\",\"runId\":\"${{ github.run_id }}\",\"prNumber\":${{ github.event.pull_request.number || github.event.issue.number }},\"timestamp\":\"'\"$TIMESTAMP\"'\",\"sourceRunId\":\"'\"$SOURCE_RUN_ID\"'\",\"validatedFindings\":[...],\"additionalFindings\":[...]}\\nEND_PAYLOAD -->\\n\\n*ðŸ¤– Automated by Claude Code Review Workflow*'\\n```\\n\\nReplace the [...] arrays with actual JSON of your validated findings.",
              "env": {
                "NODE_ENV": "test",
                "CI": "true",
                "PR_NUMBER": "${{ github.event.pull_request.number || github.event.issue.number }}"
              }
            }
        env:
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          GH_TOKEN: ${{ github.token }}

  triage:
    name: Finding Triage
    runs-on: ubuntu-latest
    needs: [pre-check, review, self-review]
    if: always() && needs.self-review.result == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fetch all PR comments
        id: comments
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.issue.number || github.event.pull_request.number }}"
          echo "Fetching all comments for PR #$PR_NUMBER"

          # Wait to ensure previous jobs' comments are posted
          sleep 10

          # Get all claude comments (review + self-review)
          gh pr view "$PR_NUMBER" --json comments --jq \
            '.comments | map(select(.author.login == "claude")) | .[].body' \
            > /tmp/all-review-comments.txt

          echo "Fetched $(wc -l < /tmp/all-review-comments.txt) comment(s)"
          echo "=== All Review Comments ==="
          cat /tmp/all-review-comments.txt
          echo "=========================="

      - name: Configure Git
        run: |
          git config --global user.name "claude-code[bot]"
          git config --global user.email "claude-code[bot]@users.noreply.github.com"

      - name: Triage and Act
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          claude_args: |
            --allowedTools "Read,Write,Edit,Glob,Grep,Bash(npm:*),Bash(npx:*),Bash(git:add*),Bash(git:commit*),Bash(git:push),Bash(git:status*),Bash(git:diff*),Bash(git:config*),Bash(node:*),Bash(gh:*),Bash(date:*),Bash(cat:*)"
            --max-turns 20
          settings: |
            {
              "instructions": "# ðŸŽ¯ TRIAGE (Job 3 of 3)\\n\\nYou are processing validated findings and taking action for PR #${{ github.event.pull_request.number || github.event.issue.number }}.\\n\\n## Step 1: Parse Validation Payload\\n\\nRead /tmp/all-review-comments.txt and find the VALIDATION comment from Job 2.\\nLook for `<!-- CLAUDE_PAYLOAD` and extract the JSON with `validatedFindings` and `additionalFindings`.\\n\\n## Step 2: Process Findings\\n\\nFor each finding where `falsePositive` is NOT true:\\n\\n### CRITICAL Findings - Fix Immediately\\n1. Edit the code to fix the issue\\n2. Run `npm test` to verify\\n3. Commit: `git commit -m \\\"fix: <description> [F-XXX]\\\"` \\n4. Push to PR branch\\n5. Record: `{\\\"id\\\": \\\"F-XXX\\\", \\\"action\\\": \\\"fixed\\\", \\\"commit\\\": \\\"<sha>\\\"}`\\n\\n### MEDIUM/LOW Findings - Create Follow-up Issue\\n\\nUse this EXACT command (replace placeholders):\\n```bash\\ngh issue create --title \\\"[FOLLOW-UP] <title>\\\" --body \\\"## Location\\n- **File:** \\\\`<file>\\\\`\\n- **Lines:** <lineStart> - <lineEnd>\\n\\n## Description\\n<description>\\n\\n## Suggested Fix\\n<recommendation>\\n\\n---\\n<!-- ISSUE_LINKAGE\\nSource-PR: #${{ github.event.pull_request.number || github.event.issue.number }}\\nSource-SHA: ${{ github.sha }}\\nClaude-Run-ID: ${{ github.run_id }}\\nFinding-ID: <id>\\nEND_LINKAGE -->\\n\\n*Created by Claude Review Workflow*\\\" --label follow-up --label priority/<severity> --label claude-generated\\n```\\n\\n**Log every command and capture the issue number from output.**\\n\\n### SKIPPED Findings (falsePositive=true)\\nRecord: `{\\\"id\\\": \\\"F-XXX\\\", \\\"action\\\": \\\"skipped\\\", \\\"reason\\\": \\\"false-positive\\\"}`\\n\\n## Step 3: Validate Issue Creation\\n\\nIf there are MEDIUM or LOW findings that are NOT false positives, at least one issue MUST be created.\\nIf zero issues created when expected, FAIL with error.\\n\\n## Step 4: Post Branded Summary Comment\\n\\n```bash\\nTIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)\\n\\ngh pr comment ${{ github.event.pull_request.number || github.event.issue.number }} --body '## ðŸŽ¯ TRIAGE (Job 3/3)\\n\\n> **Job:** Triage | **Run:** ${{ github.run_id }} | **SHA:** ${{ github.sha }}\\n\\n---\\n\\n### Summary\\n| Metric | Count |\\n|--------|-------|\\n| Critical Fixed | X |\\n| Issues Created | X |\\n| Skipped (False Positives) | X |\\n\\n### Actions Taken\\n| Finding | Severity | Action | Result |\\n|---------|----------|--------|--------|\\n| F-001 | critical | fixed | commit abc123 |\\n| F-002 | medium | issue-created | #45 |\\n\\n---\\n\\n<!-- CLAUDE_PAYLOAD\\n{\\\"version\\\":1,\\\"job\\\":\\\"triage\\\",\\\"runId\\\":\\\"${{ github.run_id }}\\\",\\\"prNumber\\\":${{ github.event.pull_request.number || github.event.issue.number }},\\\"sha\\\":\\\"${{ github.sha }}\\\",\\\"timestamp\\\":\\\"'\\\"$TIMESTAMP\\\"'\\\",\\\"actions\\\":[...],\\\"summary\\\":{\\\"criticalFixed\\\":X,\\\"issuesCreated\\\":X,\\\"skipped\\\":X}}\\nEND_PAYLOAD -->\\n\\n*ðŸ¤– Automated by Claude Code Review Workflow*'\\n```\\n\\nReplace X with actual counts and [...] with actual actions array.",
              "env": {
                "NODE_ENV": "test",
                "CI": "true",
                "PR_NUMBER": "${{ github.event.pull_request.number || github.event.issue.number }}"
              }
            }
        env:
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          GH_TOKEN: ${{ github.token }}
