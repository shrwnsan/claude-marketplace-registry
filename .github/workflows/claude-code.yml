name: Claude Code Assistant

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize, reopened]
  issues:
    types: [opened, edited]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: number

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  id-token: write

jobs:
  pre-check:
    name: Pre-Check Validation
    runs-on: ubuntu-latest
    # Only run when @claude is mentioned by members/collaborators
    if: |
      ((github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
       (github.event_name == 'pull_request' && contains(github.event.pull_request.body || '', '@claude')) ||
       (github.event_name == 'issues' && contains(github.event.issue.body || '', '@claude'))) &&
      (github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'OWNER' ||
       github.event.comment.author_association == 'COLLABORATOR' ||
       github.event.issue.author_association == 'MEMBER' ||
       github.event.issue.author_association == 'OWNER' ||
       github.event.issue.author_association == 'COLLABORATOR' ||
       github.event.pull_request.user.author_association == 'MEMBER' ||
       github.event.pull_request.user.author_association == 'OWNER' ||
       github.event.pull_request.user.author_association == 'COLLABORATOR')

    outputs:
      lint-status: ${{ steps.lint.outputs.status }}
      format-status: ${{ steps.format.outputs.status }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint (continue on failure)
        id: lint
        run: |
          npm run lint 2>&1 | tee /tmp/lint.log
          LINT_EXIT_CODE=${PIPESTATUS[0]}
          if [ $LINT_EXIT_CODE -eq 0 ]; then
            echo "status=pass" >> $GITHUB_OUTPUT
          else
            echo "status=fail" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Check formatting (continue on failure)
        id: format
        run: |
          npm run format:check 2>&1 | tee /tmp/format.log
          FORMAT_EXIT_CODE=${PIPESTATUS[0]}
          if [ $FORMAT_EXIT_CODE -eq 0 ]; then
            echo "status=pass" >> $GITHUB_OUTPUT
          else
            echo "status=fail" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Upload lint results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pre-check-results
          path: |
            /tmp/lint.log
            /tmp/format.log
          retention-days: 1

  review:
    name: Code Review
    runs-on: ubuntu-latest
    needs: pre-check
    if: always() && needs.pre-check.result == 'success'

    outputs:
      review-artifact: ${{ steps.review.outputs.artifact_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download pre-check results
        uses: actions/download-artifact@v4
        with:
          name: pre-check-results
          path: /tmp
        continue-on-error: true

      - name: Run Code Review
        id: review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          claude_args: |
            --allowedTools "Read,Glob,Grep,WebSearch,WebFetch"
            --max-turns 10
          settings: |
            {
              "instructions": "You are a code reviewer for this PR.\n\nPre-check status:\n- ESLint: ${{ needs.pre-check.outputs.lint-status }}\n- Prettier: ${{ needs.pre-check.outputs.format-status }}\n\nAnalyze this PR for:\n1. Security Issues (OWASP Top 10, auth flaws, injection)\n2. Code Quality (type safety, error handling, performance)\n3. Best Practices (framework patterns, conventions)\n4. Breaking Changes (API changes, migration needed)\n\nCategorize findings by severity:\n- **critical**: Security vulnerabilities, crashes, data loss risks\n- **medium**: Code quality issues, missing error handling, performance concerns\n- **low**: Style inconsistencies, minor improvements, nice-to-haves\n\nPost your findings as a comment on this PR. Include structured findings that can be parsed by downstream jobs.",
              "env": {
                "NODE_ENV": "test",
                "CI": "true"
              }
            }
        env:
          # Z.ai API endpoint for cost optimization and rate limiting
          # Z.ai is our trusted LLM inference provider
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic

  self-review:
    name: Review Validation
    runs-on: ubuntu-latest
    needs: [pre-check, review]
    if: always() && needs.review.result == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fetch PR comments
        id: comments
        run: |
          PR_NUMBER="${{ github.event.issue.number || github.event.pull_request.number }}"
          echo "Fetching comments for PR #$PR_NUMBER"

          # Wait a moment to ensure previous job's comment is posted
          sleep 10

          # Get all comments from the review job (by claude bot)
          gh pr view "$PR_NUMBER" --json comments --jq \
            '.comments | map(select(.author.login == "claude")) | .[].body' \
            > /tmp/review-comments.txt

          echo "Fetched $(wc -l < /tmp/review-comments.txt) comment(s)"
          echo "=== Review Comments ==="
          cat /tmp/review-comments.txt
          echo "======================"

      - name: Validate Review
        id: validate
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          claude_args: |
            --allowedTools "Read,Glob,Grep,WebSearch,WebFetch"
            --max-turns 8
          settings: |
            {
              "instructions": "You are validating a code review.\n\nRead /tmp/review-comments.txt which contains the previous review job's comments.\n\nYour tasks:\n1. **Check for misses**: Look for issues the original review missed:\n   - OWASP Top 10 vulnerabilities\n   - Performance anti-patterns\n   - Breaking changes\n   - Type safety issues\n\n2. **Validate findings**: For each item in the original review:\n   - Is this a real issue? (not false positive)\n   - Is the location accurate?\n   - Is the severity correct?\n\n3. **Post your validation results** as a comment on this PR.",
              "env": {
                "NODE_ENV": "test",
                "CI": "true"
              }
            }
        env:
          # Z.ai API endpoint for cost optimization and rate limiting
          # Z.ai is our trusted LLM inference provider
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          GH_TOKEN: ${{ github.token }}

  triage:
    name: Finding Triage
    runs-on: ubuntu-latest
    needs: [pre-check, review, self-review]
    if: always() && needs.self-review.result == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fetch all PR comments
        id: comments
        run: |
          PR_NUMBER="${{ github.event.issue.number || github.event.pull_request.number }}"
          echo "Fetching all comments for PR #$PR_NUMBER"

          # Wait to ensure previous jobs' comments are posted
          sleep 5

          # Get all claude comments (review + self-review)
          gh pr view "$PR_NUMBER" --json comments --jq \
            '.comments | map(select(.author.login == "claude")) | .[].body' \
            > /tmp/all-review-comments.txt

          echo "Fetched $(wc -l < /tmp/all-review-comments.txt) comment(s)"
          echo "=== All Review Comments ==="
          cat /tmp/all-review-comments.txt
          echo "=========================="

      - name: Configure Git
        run: |
          git config --global user.name "claude-code[bot]"
          git config --global user.email "claude-code[bot]@users.noreply.github.com"

      - name: Triage and Act
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          claude_args: |
            --allowedTools "Read,Write,Edit,Glob,Grep,Bash(npm:*),Bash(npx:*),Bash(git:add*),Bash(git:commit*),Bash(git:push),Bash(git:status*),Bash(git:diff*),Bash(git:config*),Bash(node:*),Bash(gh:*)"
            --max-turns 15
          settings: |
            {
              "instructions": "You are triaging code review findings.\n\nRead /tmp/all-review-comments.txt which contains the review and self-review comments.\n\nFor each finding:\n\n**CRITICAL findings** - Implement immediately:\n1. Use Edit/Write tools to fix the code\n2. Run tests: npm test\n3. Commit changes\n4. Push to the PR branch\n\n**MEDIUM findings** - Create follow-up issue:\n- Use gh issue create with title prefix '[FOLLOW-UP]'\n- Add labels: follow-up, priority/medium, claude-generated\n- Reference source PR in body: 'From PR #${PR_NUMBER}'\n- Include location, description, and suggested fix\n\n**LOW findings** - Create follow-up issue:\n- Use gh issue create with title prefix '[FOLLOW-UP]'\n- Add labels: follow-up, priority/low, claude-generated\n- Reference source PR in body: 'From PR #${PR_NUMBER}'\n- Include location, description, and suggested fix\n\nAfter processing, comment on the PR with a summary of actions taken.",
              "env": {
                "NODE_ENV": "test",
                "CI": "true",
                "PR_NUMBER": "${{ github.event.pull_request.number || github.event.issue.number }}"
              }
            }
        env:
          # Z.ai API endpoint for cost optimization and rate limiting
          # Z.ai is our trusted LLM inference provider
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          GH_TOKEN: ${{ github.token }}
