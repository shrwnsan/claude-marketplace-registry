name: Claude Code Assistant

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize, reopened]
  issues:
    types: [opened, edited]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: number

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  id-token: write

jobs:
  pre-check:
    name: Pre-Check Validation
    runs-on: ubuntu-latest
    # Only run when @claude is mentioned by members/collaborators
    if: |
      ((github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
       (github.event_name == 'pull_request' && contains(github.event.pull_request.body || '', '@claude')) ||
       (github.event_name == 'issues' && contains(github.event.issue.body || '', '@claude'))) &&
      (github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'OWNER' ||
       github.event.comment.author_association == 'COLLABORATOR' ||
       github.event.issue.author_association == 'MEMBER' ||
       github.event.issue.author_association == 'OWNER' ||
       github.event.issue.author_association == 'COLLABORATOR' ||
       github.event.pull_request.user.author_association == 'MEMBER' ||
       github.event.pull_request.user.author_association == 'OWNER' ||
       github.event.pull_request.user.author_association == 'COLLABORATOR')

    outputs:
      lint-status: ${{ steps.lint.outputs.status }}
      format-status: ${{ steps.format.outputs.status }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint (continue on failure)
        id: lint
        run: |
          npm run lint 2>&1 | tee /tmp/lint.log
          LINT_EXIT_CODE=${PIPESTATUS[0]}
          if [ $LINT_EXIT_CODE -eq 0 ]; then
            echo "status=pass" >> $GITHUB_OUTPUT
          else
            echo "status=fail" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Check formatting (continue on failure)
        id: format
        run: |
          npm run format:check 2>&1 | tee /tmp/format.log
          FORMAT_EXIT_CODE=${PIPESTATUS[0]}
          if [ $FORMAT_EXIT_CODE -eq 0 ]; then
            echo "status=pass" >> $GITHUB_OUTPUT
          else
            echo "status=fail" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Upload lint results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pre-check-results
          path: |
            /tmp/lint.log
            /tmp/format.log
          retention-days: 1

  review:
    name: Code Review
    runs-on: ubuntu-latest
    needs: pre-check
    if: always() && needs.pre-check.result == 'success'

    outputs:
      review-artifact: ${{ steps.review.outputs.artifact_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download pre-check results
        uses: actions/download-artifact@v4
        with:
          name: pre-check-results
          path: /tmp
        continue-on-error: true

      - name: Run Code Review
        id: review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          claude_args: |
            --allowedTools "Read,Glob,Grep,WebSearch,WebFetch"
            --max-turns 10
          settings: |
            {
              "instructions": "You are the CODE REVIEW job (Job 1 of 3).\\n\\nIMPORTANT: Your comment MUST include a machine-readable payload block.\\n\\nPre-check status:\\n- ESLint: ${{ needs.pre-check.outputs.lint-status }}\\n- Prettier: ${{ needs.pre-check.outputs.format-status }}\\n\\nAnalyze this PR for:\\n1. Security Issues (OWASP Top 10, auth flaws, injection)\\n2. Code Quality (type safety, error handling, performance)\\n3. Best Practices (framework patterns, conventions)\\n4. Breaking Changes (API changes, migration needed)\\n\\nFor each finding, assign:\\n- **id**: F-001, F-002, etc.\\n- **severity**: critical | medium | low\\n- **category**: security | quality | performance | breaking-change | style\\n- **file**: exact file path\\n- **lineStart/lineEnd**: line numbers if applicable\\n- **title**: brief summary\\n- **description**: detailed explanation\\n- **recommendation**: how to fix\\n\\nStructure your comment as:\\n\\n---\\n\\n## üîç CODE REVIEW (Job 1/3)\\nCLAUDE_JOB=review\\n\\n[Human-readable findings organized by severity]\\n\\n<!-- CLAUDE_REVIEW_PAYLOAD_START\\n{\\n  \"version\": 1,\\n  \"job\": \"review\",\\n  \"runId\": \"${{ github.run_id }}\",\\n  \"prNumber\": ${{ github.event.pull_request.number }},\\n  \"timestamp\": \"[INSERT_ISO_TIMESTAMP]\",\\n  \"findings\": [\\n    {\\n      \"id\": \"F-001\",\\n      \"severity\": \"critical\",\\n      \"category\": \"security\",\\n      \"file\": \"path/to/file.ts\",\\n      \"lineStart\": 42,\\n      \"lineEnd\": 58,\\n      \"title\": \"SQL Injection vulnerability\",\\n      \"description\": \"User input is concatenated directly...\",\\n      \"recommendation\": \"Use parameterized queries...\"\\n    }\\n  ]\\n}\\nCLAUDE_REVIEW_PAYLOAD_END -->\\n\\n---\\n\\nReplace [INSERT_ISO_TIMESTAMP] with current ISO 8601 timestamp when generating your response.\\n\\nPost your findings as a comment on this PR.",
              "env": {
                "NODE_ENV": "test",
                "CI": "true"
              }
            }
        env:
          # Z.ai API endpoint for cost optimization and rate limiting
          # Z.ai is our trusted LLM inference provider
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic

  self-review:
    name: Review Validation
    runs-on: ubuntu-latest
    needs: [pre-check, review]
    if: always() && needs.review.result == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fetch PR comments
        id: comments
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.issue.number || github.event.pull_request.number }}"
          echo "Fetching comments for PR #$PR_NUMBER"

          # Wait a moment to ensure previous job's comment is posted
          sleep 10

          # Get all comments from the review job (by claude bot)
          gh pr view "$PR_NUMBER" --json comments --jq \
            '.comments | map(select(.author.login == "claude")) | .[].body' \
            > /tmp/review-comments.txt

          echo "Fetched $(wc -l < /tmp/review-comments.txt) comment(s)"
          echo "=== Review Comments ==="
          cat /tmp/review-comments.txt
          echo "======================"

      - name: Validate Review
        id: validate
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          claude_args: |
            --allowedTools "Read,Glob,Grep,WebSearch,WebFetch"
            --max-turns 15
          settings: |
            {
              "instructions": "You are the REVIEW VALIDATION job (Job 2 of 3).\\n\\nIMPORTANT: Your comment MUST include a machine-readable payload block.\\n\\nFirst, read /tmp/review-comments.txt and find the CLAUDE_REVIEW_PAYLOAD block.\\nParse the JSON payload to get the list of findings from Job 1.\\n\\nFor each finding in the payload:\\n1. Verify the issue exists at the stated location\\n2. Confirm severity is appropriate\\n3. Check for false positives\\n4. Set 'validated: true' if confirmed, 'falsePositive: true' if not real\\n\\nAlso check for issues the original review missed:\\n- OWASP Top 10 vulnerabilities\\n- Performance anti-patterns\\n- Breaking changes\\n- Type safety issues\\n\\nStructure your comment as:\\n\\n---\\n\\n## ‚úÖ REVIEW VALIDATION (Job 2/3)\\nCLAUDE_JOB=self-review\\n\\n[Human-readable validation results]\\n\\n<!-- CLAUDE_REVIEW_PAYLOAD_START\\n{\\n  \"version\": 1,\\n  \"job\": \"self-review\",\\n  \"runId\": \"${{ github.run_id }}\",\\n  \"prNumber\": PR_NUMBER,\\n  \"timestamp\": \"ISO_TIMESTAMP\",\\n  \"sourceRunId\": \"RUN_ID_FROM_REVIEW_PAYLOAD\",\\n  \"validatedFindings\": [\\n    {\\n      \"id\": \"F-001\",\\n      \"... original fields ...\",\\n      \"validated\": true,\\n      \"falsePositive\": false\\n    }\\n  ],\\n  \"additionalFindings\": [\\n    {\\n      \"id\": \"F-NEW-001\",\\n      \"... new finding fields ...\"\\n    }\\n  ]\\n}\\nCLAUDE_REVIEW_PAYLOAD_END -->\\n\\n---\\n\\nReplace PR_NUMBER with actual PR number, ISO_TIMESTAMP with current timestamp, and RUN_ID_FROM_REVIEW_PAYLOAD with the runId from Job 1's payload.",
              "env": {
                "NODE_ENV": "test",
                "CI": "true"
              }
            }
        env:
          # Z.ai API endpoint for cost optimization and rate limiting
          # Z.ai is our trusted LLM inference provider
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          GH_TOKEN: ${{ github.token }}

  triage:
    name: Finding Triage
    runs-on: ubuntu-latest
    needs: [pre-check, review, self-review]
    if: always() && needs.self-review.result == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fetch all PR comments
        id: comments
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.issue.number || github.event.pull_request.number }}"
          echo "Fetching all comments for PR #$PR_NUMBER"

          # Wait to ensure previous jobs' comments are posted
          sleep 10

          # Get all claude comments (review + self-review)
          gh pr view "$PR_NUMBER" --json comments --jq \
            '.comments | map(select(.author.login == "claude")) | .[].body' \
            > /tmp/all-review-comments.txt

          echo "Fetched $(wc -l < /tmp/all-review-comments.txt) comment(s)"
          echo "=== All Review Comments ==="
          cat /tmp/all-review-comments.txt
          echo "=========================="

      - name: Configure Git
        run: |
          git config --global user.name "claude-code[bot]"
          git config --global user.email "claude-code[bot]@users.noreply.github.com"

      - name: Triage and Act
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_ZAI_API_KEY }}
          claude_args: |
            --allowedTools "Read,Write,Edit,Glob,Grep,Bash(npm:*),Bash(npx:*),Bash(git:add*),Bash(git:commit*),Bash(git:push),Bash(git:status*),Bash(git:diff*),Bash(git:config*),Bash(node:*),Bash(gh:*)"
            --max-turns 15
          settings: |
            {
              "instructions": "<!-- CLAUDE_JOB=triage -->\\n\\nYou are the TRIAGE job (Job 3 of 3).\\n\\n## STEP 1: Parse Validation Payload\\n\\nRead /tmp/all-review-comments.txt and extract the JSON payload from the self-review job (look for job=\\\"self-review\\\" in the payload).\\n\\nThe payload structure is:\\n```json\\n{\\n  \\\"job\\\": \\\"self-review\\\",\\n  \\\"findings\\\": [\\n    {\\n      \\\"id\\\": \\\"finding-xxx\\\",\\n      \\\"severity\\\": \\\"critical|medium|low\\\",\\n      \\\"file\\\": \\\"path/to/file\\\",\\n      \\\"startLine\\\": 10,\\n      \\\"endLine\\\": 20,\\n      \\\"description\\\": \\\"...\\\",\\n      \\\"recommendation\\\": \\\"...\\\",\\n      \\\"falsePositive\\\": true|false,\\n      \\\"reason\\\": \\\"...\\\"\\n    }\\n  ]\\n}\\n```\\n\\n## STEP 2: Process Validated Findings Only\\n\\nFor each finding where `falsePositive=false`:\\n\\n**CRITICAL findings** - Fix immediately:\\n1. Use Edit/Write tools to fix the code\\n2. Run tests: npm test\\n3. Commit with descriptive message\\n4. Push to PR branch\\n5. Record action: {\\\"id\\\": \\\"<finding_id>\\\", \\\"action\\\": \\\"fixed\\\", \\\"commit\\\": \\\"<sha>\\\"}\\n\\n**MEDIUM/LOW findings** - Create follow-up issue with ISSUE_LINKAGE:\\n\\n```bash\\ngh issue create \\\\\\n  --title \\\"[FOLLOW-UP] <brief title>\\\" \\\\\\n  --body \\\"## Location\\n- **File:** \\\\`<file>\\\\`\\n- **Lines:** <startLine> - <endLine>\\n\\n## Description\\n<description>\\n\\n## Suggested Fix\\n<recommendation>\\n\\n---\\n\\n<!-- ISSUE_LINKAGE_START\\nSource-PR: #${{ env.PR_NUMBER }}\\nSource-SHA: ${{ github.sha }}\\nClaude-Run-ID: ${{ github.run_id }}\\nFinding-ID: <finding_id>\\nISSUE_LINKAGE_END -->\\n\\n*Created by Claude Review Workflow from PR #${{ env.PR_NUMBER }}*\\\" \\\\\\n  --label follow-up \\\\\\n  --label priority/<severity> \\\\\\n  --label claude-generated\\n```\\n\\n**IMPORTANT:** Log EVERY gh command and its exit code. Example:\\n```\\nRunning: gh issue create --title \\\"[FOLLOW-UP] Fix X\\\" ...\\nExit code: 0\\nCreated issue: #123\\n```\\n\\nRecord action: {\\\"id\\\": \\\"<finding_id>\\\", \\\"action\\\": \\\"issue-created\\\", \\\"issueNumber\\\": <num>}\\n\\n**SKIPPED findings** (falsePositive=true):\\nRecord action: {\\\"id\\\": \\\"<finding_id>\\\", \\\"action\\\": \\\"skipped\\\", \\\"reason\\\": \\\"false-positive\\\"}\\n\\n## STEP 3: Validate Issue Creation\\n\\nIf there are MEDIUM or LOW findings with falsePositive=false, at least one issue MUST be created.\\nIf zero issues are created when they should be, FAIL the job with an error message.\\n\\n## STEP 4: Output Triage Payload\\n\\nComment on the PR with:\\n\\n```markdown\\n## üéØ TRIAGE (Job 3/3)\\n\\n### Summary\\n- Critical fixed: <count>\\n- Issues created: <count> (list issue numbers)\\n- Skipped (false positives): <count>\\n\\n### Actions Taken\\n<table of finding_id, severity, action, result>\\n\\n<!-- STRUCTURED_PAYLOAD_START\\n```json\\n{\\n  \\\"job\\\": \\\"triage\\\",\\n  \\\"prNumber\\\": ${{ env.PR_NUMBER }},\\n  \\\"runId\\\": \\\"${{ github.run_id }}\\\",\\n  \\\"sha\\\": \\\"${{ github.sha }}\\\",\\n  \\\"actions\\\": [\\n    {\\\"id\\\": \\\"finding-xxx\\\", \\\"action\\\": \\\"fixed|issue-created|skipped\\\", ...}\\n  ],\\n  \\\"summary\\\": {\\n    \\\"criticalFixed\\\": <n>,\\n    \\\"issuesCreated\\\": <n>,\\n    \\\"skipped\\\": <n>\\n  }\\n}\\n```\\nSTRUCTURED_PAYLOAD_END -->\\n```",
              "env": {
                "NODE_ENV": "test",
                "CI": "true",
                "PR_NUMBER": "${{ github.event.pull_request.number || github.event.issue.number }}"
              }
            }
        env:
          # Z.ai API endpoint for cost optimization and rate limiting
          # Z.ai is our trusted LLM inference provider
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          GH_TOKEN: ${{ github.token }}
