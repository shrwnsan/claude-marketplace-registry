name: Issue Triage

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  auto-label:
    name: Auto Label Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && (github.event.action == 'opened' || github.event.action == 'reopened')

    steps:
      - name: Auto label based on content
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = issue.body ? issue.body.toLowerCase() : '';
            const content = title + ' ' + body;

            const labels = [];

            // Bug detection
            if (content.includes('bug') || content.includes('error') || content.includes('issue') || content.includes('broken')) {
              labels.push('bug');
            }

            // Feature request detection
            if (content.includes('feature') || content.includes('enhancement') || content.includes('add') || content.includes('new')) {
              labels.push('enhancement');
            }

            // Documentation detection
            if (content.includes('doc') || content.includes('readme') || content.includes('guide')) {
              labels.push('documentation');
            }

            // Marketplace related
            if (content.includes('marketplace') || content.includes('plugin') || content.includes('scan')) {
              labels.push('marketplace');
            }

            // CI/CD related
            if (content.includes('ci') || content.includes('deploy') || content.includes('workflow') || content.includes('github action')) {
              labels.push('ci/cd');
            }

            // Add labels if any were identified
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
            }

            // Add welcome comment for new issues
            if (context.payload.action === 'opened') {
              const labelsList = labels.length > 0
                ? labels.map(label => '- `' + label + '`').join('\n')
                : 'No labels applied';
              const welcomeBody = '## ğŸ‘‹ Welcome! Thank you for opening an issue.\n\n' +
                '### ğŸ“‹ Next Steps\n' +
                '1. A maintainer will review your issue shortly\n' +
                '2. Please provide any additional information if requested\n' +
                '3. Check for updates on this issue\n\n' +
                '### ğŸ·ï¸ Auto-applied labels\n' +
                labelsList + '\n';
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: welcomeBody
              });
            }

  auto-respond:
    name: Auto Respond to Common Questions
    runs-on: ubuntu-latest
    if: github.event_name == 'issue_comment'

    steps:
      - name: Auto respond to common questions
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment;
            const body = comment.body.toLowerCase();

            // Skip if comment is from bot
            if (comment.user.type === 'Bot') {
              return;
            }

            let response = '';

            // Common responses
            if (body.includes('how to deploy') || body.includes('deployment')) {
              response = '## ğŸš€ Deployment Information\n\n' +
                'This project uses GitHub Pages for deployment. The deployment process is automated through GitHub Actions.\n\n' +
                '### ğŸ“ Deployment Steps\n' +
                '1. Push changes to the `main` branch\n' +
                '2. CI pipeline runs automatically\n' +
                '3. If all checks pass, deployment to GitHub Pages occurs\n' +
                '4. Site is live at: https://' + context.repo.owner + '.github.io/' + context.repo.repo + '\n\n' +
                '### ğŸ”§ Configuration\n' +
                '- Deployment workflow: `.github/workflows/deploy.yml`\n' +
                '- Static export configuration in `next.config.js`\n' +
                '- GitHub Pages settings in repository settings\n\n' +
                'Need help? Check the [README](../README.md) or open a new issue.\n';
            }

            if (body.includes('how to scan') || body.includes('scan marketplaces')) {
              response = '## ğŸ” Scanning Information\n\n' +
                'This project includes automated marketplace scanning capabilities.\n\n' +
                '### ğŸ“‹ Scan Types\n' +
                '- **Marketplace Scan**: Searches GitHub for new marketplaces\n' +
                '- **Plugin Validation**: Validates plugin metadata and functionality\n' +
                '- **Data Generation**: Generates JSON data files for the website\n\n' +
                '### ğŸš€ Running Scans\n' +
                '```bash\n' +
                '# Run full scan\n' +
                'npm run scan:full\n\n' +
                '# Run individual scans\n' +
                'npm run scan:marketplaces\n' +
                'npm run validate:plugins\n' +
                'npm run generate:data\n' +
                '```\n\n' +
                '### â° Scheduled Scans\n' +
                '- Automatic scans run every 6 hours\n' +
                '- Workflow: `.github/workflows/scan.yml`\n' +
                '- Results are committed automatically\n\n' +
                '### ğŸ”§ Configuration\n' +
                '- Environment variables in `.env.example`\n' +
                '- GitHub API rate limits\n' +
                '- Cache configuration for performance\n\n' +
                'Need help? Check the scripts in `/scripts/` directory or open a new issue.\n';
            }

            if (body.includes('contribute') || body.includes('how to help')) {
              response = '## ğŸ¤ Contributing Information\n\n' +
                'Thank you for your interest in contributing! Here is how you can help:\n\n' +
                '### ğŸ“‹ Ways to Contribute\n' +
                '1. **Report Issues**: Found a bug? Open an issue with details\n' +
                '2. **Feature Requests**: Have an idea? Suggest it in an issue\n' +
                '3. **Code Contributions**: Submit pull requests for improvements\n' +
                '4. **Documentation**: Help improve README and docs\n' +
                '5. **Marketplace Data**: Suggest new marketplaces to include\n\n' +
                '### ğŸš€ Getting Started\n' +
                '1. Fork the repository\n' +
                '2. Clone your fork locally\n' +
                '3. Create a feature branch: `git checkout -b feature-name`\n' +
                '4. Make your changes\n' +
                '5. Run tests: `npm test`\n' +
                '6. Submit a pull request\n\n' +
                '### ğŸ“ Development Setup\n' +
                '```bash\n' +
                '# Install dependencies\n' +
                'npm install\n\n' +
                '# Start development server\n' +
                'npm run dev\n\n' +
                '# Run tests\n' +
                'npm test\n\n' +
                '# Build for production\n' +
                'npm run build\n' +
                '```\n\n' +
                '### ğŸ”§ Project Structure\n' +
                '- `/src`: Next.js application source code\n' +
                '- `/scripts`: TypeScript scripts for scanning and data processing\n' +
                '- `/data`: Generated marketplace data files\n' +
                '- `/.github/workflows`: CI/CD pipeline configurations\n\n' +
                'Need more help? Check the [CONTRIBUTING.md](../CONTRIBUTING.md) file or ask in the comments.\n';
            }

            // Post response if generated
            if (response) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: response
              });
            }